<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Education Dashboard Self-Contained HTML Application" />
    <title>Education Dashboard</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts for Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
            background-color: #f9fafb; /* Light gray background */
            color: #1f2937; /* Darker text for readability */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Hide scrollbar for webkit browsers */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* General page styling - ensures pages fill content area */
        .page {
            min-height: calc(100vh - 80px); /* Adjust based on your header/footer height */
            padding-bottom: 5rem; /* Space for bottom navigation */
        }

        /* Ensure the main container accounts for fixed bottom nav */
        #main-content {
            padding-bottom: 5rem; /* Adjust if bottom nav height changes */
        }

        /* For the fixed notification message to be visible */
        .z-50 {
            z-index: 9999;
        }

        /* Ensure smooth transitions for page content changes */
        .page-transition {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root" class="w-full max-w-md mx-auto bg-white min-h-screen shadow-lg relative overflow-hidden"></div>

    <!-- React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in browser (for direct HTML use) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (placed before the Babel script so global Firebase objects are available) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IMPORTANT: Your actual Firebase project configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyAHowpOHnCOaQ5eackHV__Bo3M42437lXQ",
            authDomain: "daily-discussion-1040d.firebaseapp.com",
            projectId: "daily-discussion-1040d",
            storageBucket: "daily-discussion-1040d.firebasestorage.app",
            messagingSenderId: "647593805968",
            appId: "1:647593805968:web:321f52517221267163f015",
            measurementId: "G-YB5N6Q6MDZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose Firebase objects and functions globally for React components
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;

        // Set up global __app_id for data paths
        window.__app_id = firebaseConfig.projectId; // Using project ID as the app ID for storage paths

        // Initial authentication check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously to Firebase.");
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                }
            } else {
                console.log("Firebase user is logged in:", user.uid);
            }
        });
    </script>

    <script type="text/babel">
        // ErrorBoundary component to catch rendering errors
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                // Update state so the next render shows the fallback UI.
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                // You can also log the error to an error reporting service
                console.error("ErrorBoundary caught an error:", error, errorInfo);
                this.setState({
                    error: error,
                    errorInfo: errorInfo
                });
            }

            render() {
                if (this.state.hasError) {
                    // You can render any custom fallback UI
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-red-100 text-red-800 p-4 rounded-lg shadow-md">
                            <h1 className="text-xl font-bold mb-2">Oops! Something went wrong.</h1>
                            <p className="text-sm text-center mb-4">
                                We're sorry for the inconvenience. Please try refreshing the page.
                            </p>
                            {/* Optional: show error details in development */}
                            {this.state.error && (
                                <details className="mt-4 p-2 bg-red-200 rounded-md text-xs text-red-900 overflow-auto max-h-40">
                                    <summary>Error Details</summary>
                                    <pre>{this.state.error.toString()}</pre>
                                    <pre>{this.state.errorInfo.componentStack}</pre>
                                </details>
                            )}
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // Notification Component
        const NotificationMessage = ({ message, type, onClose }) => {
            let bgColor = '';
            let textColor = '';
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    break;
                case 'info':
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    break;
                default:
                    bgColor = 'bg-gray-700';
                    textColor = 'text-white';
            }

            return (
                <div className={`fixed bottom-4 left-1/2 transform -translate-x-1/2 ${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ease-out`}
                     style={{ minWidth: '200px', maxWidth: '90%' }}>
                    <div className="flex items-center justify-between">
                        <span>{message}</span>
                        <button onClick={onClose} className="ml-4 text-white hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const { useState, useEffect, useCallback } = React;
            const [currentPage, setCurrentPage] = useState('login');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [notification, setNotification] = useState({ message: '', type: '', visible: false });
            const [notificationPermission, setNotificationPermission] = useState('default'); // 'granted', 'denied', 'default'
            const [userId, setUserId] = useState(null); // State to store the authenticated user ID
            const [isAuthReady, setIsAuthReady] = useState(false); // To track if auth state is determined

            // --- Firebase Auth & Data Loading ---
            useEffect(() => {
                // Listen for auth state changes
                const unsubscribeAuth = window.onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        // Attempt anonymous sign-in if no user is found
                        window.signInAnonymously(window.auth)
                            .then(credential => {
                                setUserId(credential.user.uid);
                                console.log("Signed in anonymously:", credential.user.uid);
                            })
                            .catch(error => {
                                console.error("Error signing in anonymously:", error);
                                showNotification("Authentication failed. Data persistence may not work.", 'error');
                            });
                    }
                    setIsAuthReady(true); // Auth state has been determined
                });

                // Request notification permission on app load
                if ('Notification' in window) {
                    setNotificationPermission(Notification.permission);
                    if (Notification.permission === 'default') {
                        Notification.requestPermission().then(permission => {
                            setNotificationPermission(permission);
                        });
                    }
                }

                return () => unsubscribeAuth(); // Cleanup auth listener on component unmount
            }, []); // Empty dependency array means this runs once on mount

            // Effect for loading data from Firestore and setting up real-time listeners
            useEffect(() => {
                if (isAuthReady && userId) {
                    const userSubjectsCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "subjects");
                    const userTimetableCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "timetable");

                    // Listen for real-time updates to subjects (testData)
                    const unsubscribeSubjects = window.onSnapshot(userSubjectsCollectionRef, (snapshot) => {
                        const loadedTestData = {};
                        snapshot.forEach((doc) => {
                            loadedTestData[doc.id] = doc.data().tests || []; // Assuming tests array is stored under 'tests' field
                        });
                        setTestData(loadedTestData);
                        console.log("Test data loaded/updated from Firestore.");
                        if (Object.keys(loadedTestData).length === 0) {
                            showNotification("No subjects found. Add new subjects to get started!", 'info');
                        }
                        // Adjust current selected subjects if the loaded data doesn't contain it
                        if (currentSelectedSubject && !loadedTestData.hasOwnProperty(currentSelectedSubject)) {
                             setCurrentSelectedSubject(Object.keys(loadedTestData).length > 0 ? Object.keys(loadedTestData)[0] : '');
                        }
                         if (currentTimetableSubject && !loadedTestData.hasOwnProperty(currentTimetableSubject)) {
                             setCurrentTimetableSubject(Object.keys(loadedTestData).length > 0 ? Object.keys(loadedTestData)[0] : '');
                        }

                    }, (error) => {
                        console.error("Error listening to subjects data:", error);
                        showNotification("Failed to load subjects data.", 'error');
                    });

                    // Listen for real-time updates to timetable entries
                    const unsubscribeTimetable = window.onSnapshot(userTimetableCollectionRef, (snapshot) => {
                        const loadedTimetableEntries = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setTimetableEntries(loadedTimetableEntries);
                        console.log("Timetable data loaded/updated from Firestore.");
                    }, (error) => {
                        console.error("Error listening to timetable data:", error);
                        showNotification("Failed to load timetable data.", 'error');
                    });

                    // Set initial focus items from loaded test data (first subject's tests)
                    // This logic might need refinement based on how you want "Today's Focus" to persist.
                    // For now, it will load the sample data, then update if Firestore has data.
                     const initialSubjectKey = Object.keys(testData)[0];
                     if (initialSubjectKey && testData[initialSubjectKey]?.length > 0) {
                        const initialFocus = testData[initialSubjectKey].slice(0, 2).map(test => ({
                            id: `${initialSubjectKey}-${test.title}`,
                            subject: initialSubjectKey,
                            title: test.title,
                            mcqs: test.mcqs,
                            type: "Custom", // Can be dynamic if you add a type to your test data
                            iconPath: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm13 14v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"
                        }));
                        setTodayFocusItems(initialFocus);
                    }


                    // Cleanup listeners on unmount or userId change
                    return () => {
                        unsubscribeSubjects();
                        unsubscribeTimetable();
                    };
                }
            }, [isAuthReady, userId]); // Re-run when auth state is ready or user changes

            // Effect to hide notification automatically
            useEffect(() => {
                if (notification.visible) {
                    const timer = setTimeout(() => {
                        setNotification(prev => ({ ...prev, visible: false }));
                    }, 3000); // Hide after 3 seconds
                    return () => clearTimeout(timer);
                }
            }, [notification.visible]);

            const showNotification = useCallback((message, type = 'info') => {
                setNotification({ message, type, visible: true });
            }, []);

            // Initial Sample Data (will be overwritten by Firestore if data exists)
            const [testData, setTestData] = useState({}); // Start empty, let Firestore populate
            const [todayFocusItems, setTodayFocusItems] = useState([]); // Start empty, let Firestore populate
            const [timetableEntries, setTimetableEntries] = useState([]); // Start empty, let Firestore populate


            const [currentSelectedSubject, setCurrentSelectedSubject] = useState(''); // For TestsCompletedPage
            const [currentTimetableSubject, setCurrentTimetableSubject] = useState(''); // For TimetablePage progress

            // --- Utility Functions ---
            const getRandomChange = () => {
                const isPositive = Math.random() > 0.5;
                const value = Math.floor(Math.random() * 5) + 1;
                const colorClass = isPositive ? 'text-green-500' : 'text-red-500';
                const sign = isPositive ? '+' : '-';
                return `<span class="${colorClass} text-lg font-semibold">${sign}${value}</span>`;
            };

            // --- Data Manipulation Callbacks (Firestore Integrated) ---
            const addSubject = useCallback(async (subjectName) => {
                if (!userId) { showNotification('Authentication not ready. Please wait.', 'error'); return; }
                if (!subjectName) {
                    showNotification('Subject name is required.', 'error');
                    return;
                }
                // Check locally first for quicker feedback, then verify with Firestore if necessary
                if (testData.hasOwnProperty(subjectName)) {
                    showNotification(`Subject "${subjectName}" already exists.`, 'error');
                    return;
                }
                
                try {
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    await window.setDoc(subjectDocRef, { tests: [] }); // Initialize with empty tests array
                    setTestData(prevData => ({ ...prevData, [subjectName]: [] }));
                    showNotification(`Subject "${subjectName}" added successfully.`, 'success');
                } catch (error) {
                    console.error("Error adding subject:", error);
                    showNotification(`Failed to add subject "${subjectName}".`, 'error');
                }
            }, [userId, testData, showNotification]);

            const addTest = useCallback(async (subjectName, title, mcqs, date) => {
                if (!userId) { showNotification('Authentication not ready. Please wait.', 'error'); return; }
                if (!subjectName || !title || !mcqs || !date) {
                    showNotification('All test fields are required.', 'error');
                    return;
                }
                if (!testData.hasOwnProperty(subjectName)) {
                    showNotification('Subject does not exist. Please create the subject first.', 'error');
                    return;
                }
                if (testData[subjectName].some(test => test.title === title)) {
                    showNotification(`A test with the title "${title}" already exists in ${subjectName}.`, 'error');
                    return;
                }

                try {
                    const newTest = { title, mcqs: parseInt(mcqs), date };
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    
                    // Update the array using a transaction or get-update-set pattern
                    const subjectDoc = await window.getDoc(subjectDocRef);
                    if (subjectDoc.exists()) {
                        const currentTests = subjectDoc.data().tests || [];
                        const updatedTests = [...currentTests, newTest];
                        await window.setDoc(subjectDocRef, { tests: updatedTests }, { merge: true });
                        setTestData(prevData => ({
                            ...prevData,
                            [subjectName]: updatedTests
                        }));
                        showNotification(`Test "${title}" added to "${subjectName}".`, 'success');
                    } else {
                        showNotification('Subject document not found.', 'error');
                    }
                } catch (error) {
                    console.error("Error adding test:", error);
                    showNotification(`Failed to add test "${title}".`, 'error');
                }
            }, [userId, testData, showNotification]);

            const deleteSubject = useCallback(async (subjectName) => {
                if (!userId) { showNotification('Authentication not ready. Please wait.', 'error'); return; }
                if (!testData.hasOwnProperty(subjectName)) {
                    showNotification(`Subject "${subjectName}" not found.`, 'error');
                    return;
                }

                try {
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    await window.deleteDoc(subjectDocRef);
                    
                    setTestData(prevData => {
                        const updatedTestData = { ...prevData };
                        delete updatedTestData[subjectName];
                        return updatedTestData;
                    });
                    setTodayFocusItems(prevItems => prevItems.filter(item => item.subject !== subjectName));

                    if (Object.keys(testData).length > 1 && currentSelectedSubject === subjectName) {
                        setCurrentSelectedSubject(Object.keys(testData)[0]);
                    } else if (Object.keys(testData).length === 1 && currentSelectedSubject === subjectName) {
                        setCurrentSelectedSubject(''); // No subjects left
                    }
                    
                    if (Object.keys(testData).length > 1 && currentTimetableSubject === subjectName) {
                        setCurrentTimetableSubject(Object.keys(testData)[0]);
                    } else if (Object.keys(testData).length === 1 && currentTimetableSubject === subjectName) {
                        setCurrentTimetableSubject(''); // No subjects left
                    }
                    showNotification(`Subject "${subjectName}" deleted.`, 'success');
                } catch (error) {
                    console.error("Error deleting subject:", error);
                    showNotification(`Failed to delete subject "${subjectName}".`, 'error');
                }
            }, [userId, testData, currentSelectedSubject, currentTimetableSubject, showNotification]);

            const deleteTest = useCallback(async (subjectName, testTitle) => {
                if (!userId) { showNotification('Authentication not ready. Please wait.', 'error'); return; }
                if (!testData.hasOwnProperty(subjectName) || !testData[subjectName].some(test => test.title === testTitle)) {
                    showNotification(`Test "${testTitle}" not found in ${subjectName}.`, 'error');
                    return;
                }

                try {
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    
                    const subjectDoc = await window.getDoc(subjectDocRef);
                    if (subjectDoc.exists()) {
                        const currentTests = subjectDoc.data().tests || [];
                        const updatedTests = currentTests.filter(test => test.title !== testTitle);
                        await window.setDoc(subjectDocRef, { tests: updatedTests }, { merge: true });

                        setTestData(prevData => ({
                            ...prevData,
                            [subjectName]: updatedTests
                        }));
                        setTodayFocusItems(prevItems => prevItems.filter(item => !(item.subject === subjectName && item.title === testTitle)));
                        showNotification(`Test "${testTitle}" deleted from "${subjectName}".`, 'success');
                    }
                } catch (error) {
                    console.error("Error deleting test:", error);
                    showNotification(`Failed to delete test "${testTitle}".`, 'error');
                }
            }, [userId, testData, showNotification]);

            const addFocusItem = useCallback((testToAdd, subjectName) => {
                const newItemId = `${subjectName}-${testToAdd.title}`;
                const existingItem = todayFocusItems.find(item => item.id === newItemId);

                if (!existingItem) {
                    const iconPath = "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm13 14v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"; // Default icon path
                    setTodayFocusItems(prevItems => [
                        ...prevItems,
                        { ...testToAdd, id: newItemId, subject: subjectName, iconPath: testToAdd.iconPath || iconPath }
                    ]);
                    showNotification(`Added "${testToAdd.title}" to Today's Focus.`, 'success');
                } else {
                    showNotification(`"${testToAdd.title}" is already in Today's Focus.`, 'info');
                }
            }, [todayFocusItems, showNotification]);

            const removeFocusItem = useCallback((itemId) => {
                setTodayFocusItems(prevItems => prevItems.filter(item => item.id !== itemId));
                showNotification('Focus item removed.', 'success');
            }, [showNotification]);

            const addTimetableEntry = useCallback(async (subject, topic, date, time) => {
                if (!userId) { showNotification('Authentication not ready. Please wait.', 'error'); return; }
                if (!subject || !topic || !date || !time) {
                    showNotification('All fields for the timetable event are required.', 'error');
                    return;
                }
                try {
                    const timetableCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "timetable");
                    const newEntryRef = window.doc(timetableCollectionRef); // Firestore generates an ID
                    await window.setDoc(newEntryRef, { subject, topic, date, time });
                    showNotification('Study event added successfully!', 'success');

                    // Schedule local notification
                    if (notificationPermission === 'granted') {
                        const eventDateTime = new Date(`${date}T${time}`);
                        const now = new Date();
                        const timeUntilEvent = eventDateTime.getTime() - now.getTime();

                        const reminderTime = timeUntilEvent - (5 * 60 * 1000); // 5 minutes before

                        if (reminderTime > 0) {
                            setTimeout(() => {
                                new Notification('Upcoming Study Event', {
                                    body: `${topic} for ${subject} is starting soon at ${time}!`,
                                    icon: 'https://placehold.co/48x48/007bff/ffffff?text=🔔'
                                });
                            }, reminderTime);
                        } else {
                            console.warn('Event is in the past or too soon for a reminder.');
                        }
                    } else {
                        console.warn('Notification permission not granted.');
                    }
                } catch (error) {
                    console.error("Error adding timetable entry:", error);
                    showNotification("Failed to add study event.", 'error');
                }
            }, [userId, showNotification, notificationPermission]);

            const deleteTimetableEntry = useCallback(async (idToDelete) => {
                if (!userId) { showNotification('Authentication not ready. Please wait.', 'error'); return; }
                try {
                    const timetableEntryDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "timetable", idToDelete);
                    await window.deleteDoc(timetableEntryDocRef);
                    showNotification('Timetable entry deleted.', 'success');
                } catch (error) {
                    console.error("Error deleting timetable entry:", error);
                    showNotification("Failed to delete timetable entry.", 'error');
                }
            }, [userId, showNotification]);

            // --- Page Navigation ---
            const navigateTo = useCallback((pageName, options = {}) => {
                setCurrentPage(pageName);
                if (pageName === 'trophy' && options.fromTimetable && options.subject) {
                    setCurrentSelectedSubject(options.subject);
                }
                window.scrollTo(0, 0);
            }, []);

            // --- Auth Logic ---
            const handleLogin = () => {
                setIsLoggedIn(true);
                navigateTo('dashboard');
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                navigateTo('login');
                setUserId(null); // Clear user ID on logout
            };

            // Render Logic based on currentPage
            const renderPage = () => {
                if (!isAuthReady) {
                    return (
                        <div className="flex flex-col items-center justify-center min-h-screen">
                            <svg className="animate-spin h-8 w-8 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <p className="text-gray-600">Loading application...</p>
                        </div>
                    );
                }

                switch (currentPage) {
                    case 'login':
                        return <LoginPage onLogin={handleLogin} />;
                    case 'dashboard':
                        return <DashboardPage
                                    testData={testData}
                                    todayFocusItems={todayFocusItems}
                                    onEditFocus={() => navigateTo('edit-focus')}
                                    removeFocusItem={removeFocusItem}
                                />;
                    case 'timetable':
                        return <TimetablePage
                                    timetableEntries={timetableEntries}
                                    testData={testData}
                                    currentTimetableSubject={currentTimetableSubject}
                                    setCurrentTimetableSubject={setCurrentTimetableSubject}
                                    addTimetableEntry={addTimetableEntry}
                                    deleteTimetableEntry={deleteTimetableEntry}
                                    navigateToTrophyPage={(subject) => navigateTo('trophy', { fromTimetable: true, subject })}
                                />;
                    case 'trophy':
                        return <TestsCompletedPage
                                    testData={testData}
                                    currentSelectedSubject={currentSelectedSubject}
                                    setCurrentSelectedSubject={setCurrentSelectedSubject}
                                    addTest={addTest}
                                    deleteTest={deleteTest}
                                />;
                    case 'edit-focus':
                        return <EditFocusPage
                                    testData={testData}
                                    todayFocusItems={todayFocusItems}
                                    addFocusItem={addFocusItem}
                                    removeFocusItem={removeFocusItem}
                                    onBackToDashboard={() => navigateTo('dashboard')}
                                />;
                    case 'manage-tests':
                        return <ManageContentPage
                                    testData={testData}
                                    addSubject={addSubject}
                                    addTest={addTest}
                                    deleteSubject={deleteSubject}
                                    deleteTest={deleteTest}
                                    onBackToProfile={() => navigateTo('profile')}
                                />;
                    case 'profile':
                        return <ProfilePage onManageContent={() => navigateTo('manage-tests')} onLogout={handleLogout} currentUserId={userId} />;
                    default:
                        return <LoginPage onLogin={handleLogin} />;
                }
            };

            return (
                <>
                    <main id="main-content" className="pb-24">
                        {renderPage()}
                    </main>
                    {isLoggedIn && <BottomNavigation currentPage={currentPage} onNavigate={navigateTo} />}
                    {notification.visible && (
                        <NotificationMessage
                            message={notification.message}
                            type={notification.type}
                            onClose={() => setNotification(prev => ({ ...prev, visible: false }))}
                        />
                    )}
                </>
            );
        };

        // --- Reusable Components ---

        // LoginPage Component
        const LoginPage = ({ onLogin }) => {
            const { useState } = React;
            const [email, setEmail] = useState('student@test.com');
            const [password, setPassword] = useState('password');

            const handleSubmit = (e) => {
                e.preventDefault(); // This correctly prevents default form submission
                // In a real app, you'd validate credentials here
                onLogin();
            };

            return (
                <div id="login-page" className="flex flex-col items-center justify-center min-h-screen px-6 py-8">
                    <div className="w-full">
                        <div className="text-center mb-12">
                            <svg xmlns="http://www.w3.org/2000/svg" className="mx-auto h-12 w-auto text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 21h7a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2Z"></path><path d="M12 18a2 2 0 0 0 0-4 2 2 0 0 0 0 4Z"></path><path d="M12 10V6"></path></svg>
                            <h1 className="text-3xl font-bold text-gray-900 mt-4">Welcome Back!</h1>
                            <p className="text-gray-500 mt-2">Sign in to continue your progress.</p>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="email" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="you@example.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                            </div>
                            <div className="mb-6">
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="password" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                Login
                            </button>
                        </form>
                        <p className="text-center text-sm text-gray-500 mt-6">
                            Don't have an account? <a href="#" className="font-medium text-blue-600 hover:underline">Sign up</a>
                        </p>
                    </div>
                </div>
            );
        };

        // StatCard Component
        const StatCard = ({ title, value, unit, change, icon }) => {
            return (
                <div className="bg-[#FEFBF2] p-4 rounded-xl">
                    {icon}
                    <p className="text-sm text-gray-600">{unit}</p>
                    <p className="text-3xl font-bold mt-1">{value} {change}</p>
                    <p className="text-xs text-gray-400 mt-2">{title}</p>
                </div>
            );
        };

        // FocusItemCard Component
        const FocusItemCard = ({ item, onRemove }) => {
            return (
                <div id={`focus-item-${item.id}`} className="relative flex-shrink-0 w-full bg-[#FEFBF2] p-4 rounded-xl border border-gray-200">
                    <button className="absolute top-2 right-2 text-gray-400 hover:text-red-500 rounded-full p-1" onClick={() => onRemove(item.id)} aria-label="Remove from focus">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="mb-3">
                        <path d={item.iconPath}></path>
                    </svg>
                    <h3 className="font-semibold text-gray-800 leading-tight">{item.title}</h3>
                    <div className="flex justify-between items-center mt-3 text-sm">
                        <span className="text-gray-500">({item.mcqs} MCQs)</span>
                        <span className="font-semibold text-gray-700">{item.type}</span>
                    </div>
                </div>
            );
        };

        // DashboardPage Component
        const DashboardPage = ({ testData, todayFocusItems, onEditFocus, removeFocusItem }) => {
            const { useState, useEffect, useCallback } = React;
            const [stats, setStats] = useState({ days: 0, mcqs: 0, tests: 0, subjects: 0 });

            const getRandomChange = useCallback(() => {
                const isPositive = Math.random() > 0.5;
                const value = Math.floor(Math.random() * 5) + 1;
                const colorClass = isPositive ? 'text-green-500' : 'text-red-500';
                const sign = isPositive ? '+' : '-';
                return `<span class="${colorClass} text-lg font-semibold">${sign}${value}</span>`;
            }, []);

            useEffect(() => {
                let totalDays = new Set();
                let totalMCQs = 0;
                let totalTests = 0;
                let totalSubjects = new Set();

                for (const subject in testData) {
                    if (testData.hasOwnProperty(subject)) {
                        totalSubjects.add(subject);
                        testData[subject].forEach(test => {
                            totalTests++;
                            totalMCQs += test.mcqs;
                            totalDays.add(test.date);
                        });
                    }
                }
                setStats({
                    days: totalDays.size,
                    mcqs: totalMCQs,
                    tests: totalTests,
                    subjects: totalSubjects.size
                });
            }, [testData]);

            return (
                <div id="page-dashboard" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-2">
                        <h1 className="text-3xl font-bold text-gray-900">Dashboard</h1>
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-900"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                    </header>
                    <p className="text-gray-500 mb-8">Performance Overview</p>
                    <div className="grid grid-cols-2 gap-4 mb-10">
                        <StatCard
                            unit="Days"
                            value={stats.days}
                            change={<span dangerouslySetInnerHTML={{ __html: getRandomChange() }} />}
                            title="v/s last 7 days"
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>}
                        />
                        <StatCard
                            unit="MCQs"
                            value={stats.mcqs}
                            change={<span dangerouslySetInnerHTML={{ __html: getRandomChange() }} />}
                            title="v/s last 7 days"
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><path d="m19 21-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>}
                        />
                        <StatCard
                            unit="Tests"
                            value={stats.tests}
                            change={<span dangerouslySetInnerHTML={{ __html: getRandomChange() }} />}
                            title="v/s last 7 days"
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><path d="M17 3a2.828 2 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>}
                        />
                        <StatCard
                            unit="Subjects"
                            value={`${stats.subjects}/${Object.keys(testData).length}`}
                            change={<span dangerouslySetInnerHTML={{ __html: getRandomChange() }} />}
                            title="v/s last 7 days"
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>}
                        />
                    </div>
                    <div>
                        <header className="flex items-center justify-between mb-2">
                            <h2 className="text-xl font-bold text-gray-900">Today's Focus</h2>
                            <button onClick={onEditFocus} className="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit Focus</button>
                        </header>
                        <p className="text-gray-500 mb-4">Your tests today...</p>
                        {/* Removed overflow-x-auto and space-x-4 to hide slider and make items stack */}
                        <div id="today-focus-container" className="flex flex-col space-y-4 pb-4">
                            {todayFocusItems.length === 0 ? (
                                <p className="text-gray-500 text-center w-full">No focus items for today. Click "Edit Focus" to add some.</p>
                            ) : (
                                todayFocusItems.map(item => (
                                    <FocusItemCard key={item.id} item={item} onRemove={removeFocusItem} />
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // CircularProgressBar Component
        const CircularProgressBar = ({ percentage }) => {
            const radius = 15.9155; // From original SVG
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;

            return (
                <div className="relative w-20 h-20">
                    <svg className="w-full h-full" viewBox="0 0 36 36">
                        <path className="text-green-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" strokeWidth="3" stroke="currentColor" />
                        <path
                            className="progress-ring__circle text-green-500"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            strokeWidth="3"
                            strokeLinecap="round"
                            stroke="currentColor"
                            style={{ strokeDasharray: `${circumference} ${circumference}`, strokeDashoffset: offset }}
                        />
                    </svg>
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold text-green-600">{Math.round(percentage)}%</div>
                </div>
            );
        };

        // TimetableEventCard Component
        // Renamed prop from 'event' to 'events' for clarity as it receives an array
        const TimetableEventCard = ({ events, isEditMode, onDelete }) => {
            // Sort events by time within each date group
            const sortedEvents = [...events].sort((a, b) => a.time.localeCompare(b.time));
            return (
                <>
                    {sortedEvents.map(item => (
                        <div key={item.id} className="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <p className="text-xs text-gray-500">{item.time}</p>
                                <h4 className="font-semibold text-gray-800">{item.topic}</h4>
                                <p className="text-sm text-gray-600">{item.subject}</p>
                            </div>
                            {isEditMode && (
                                <button
                                    className="delete-timetable-event-btn text-red-500 hover:text-red-700 px-2 py-1 rounded-full text-sm font-medium"
                                    onClick={() => onDelete(item.id)}
                                >
                                    Delete
                                </button>
                            )}
                        </div>
                    ))}
                </>
            );
        };


        // TimetablePage Component
        const TimetablePage = ({ timetableEntries, testData, currentTimetableSubject, setCurrentTimetableSubject, addTimetableEntry, deleteTimetableEntry, navigateToTrophyPage }) => {
            const { useState, useEffect, useCallback } = React;
            const [timetableEditMode, setTimetableEditMode] = useState(false);
            const [newSubject, setNewSubject] = useState('');
            const [newTopic, setNewTopic] = useState('');
            const [newDate, setNewDate] = useState('');
            const [newTime, setNewTime] = useState('');

            const handleAddEvent = () => {
                addTimetableEntry(newSubject, newTopic, newDate, newTime);
                setNewSubject('');
                setNewTopic('');
                setNewDate('');
                setNewTime('');
            };

            const subjects = Object.keys(testData);

            const calculateProgress = useCallback(() => {
                const totalTests = testData[currentTimetableSubject] ? testData[currentTimetableSubject].length : 0;
                const completedTests = totalTests; // Assuming all tests in `testData` are "completed" for simplicity
                return totalTests > 0 ? (completedTests / totalTests) * 100 : 0;
            }, [currentTimetableSubject, testData]);

            const progressPercentage = calculateProgress();
            const completedCount = testData[currentTimetableSubject] ? testData[currentTimetableSubject].length : 0;
            const totalCount = testData[currentTimetableSubject] ? testData[currentTimetableSubject].length : 0;


            // Group entries by date for rendering
            const groupedEntries = timetableEntries.reduce((acc, entry) => {
                const date = entry.date;
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(entry);
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedEntries).sort((a, b) => new Date(a) - new Date(b));


            return (
                <div id="page-timetable" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-2">
                        <h1 className="text-3xl font-bold text-gray-900">Timetable</h1>
                        <button onClick={() => setTimetableEditMode(!timetableEditMode)} className="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            {timetableEditMode ? 'Done' : 'Edit'}
                        </button>
                    </header>
                    <p className="text-gray-500 mb-6">Upcoming Study Schedule</p>

                    <div className="mb-6">
                        <label htmlFor="select-timetable-subject" className="block text-sm font-medium text-gray-700 mb-1">Track Progress for Subject:</label>
                        <select
                            id="select-timetable-subject"
                            className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={currentTimetableSubject}
                            onChange={(e) => setCurrentTimetableSubject(e.target.value)}
                            disabled={subjects.length === 0}
                        >
                            {subjects.length === 0 && <option value="">No Subjects Available</option>}
                            {subjects.map(subject => (
                                <option key={subject} value={subject}>{subject}</option>
                            ))}
                        </select>
                    </div>

                    <div id="timetable-progress-card" onClick={() => navigateToTrophyPage(currentTimetableSubject)} className="bg-green-50 p-5 rounded-2xl flex items-center justify-between mb-8 cursor-pointer">
                        <CircularProgressBar percentage={progressPercentage} />
                        <div className="flex-1 ml-4">
                            <p className="text-sm text-gray-500">Subject</p>
                            <p id="timetable-progress-subject" className="text-xl font-bold text-gray-800">{currentTimetableSubject || 'Select Subject'}</p>
                            <p className="text-sm text-gray-500 mt-1">Tests Completed</p>
                            <p id="timetable-progress-count" className="text-lg font-bold text-gray-800">{completedCount}/{totalCount}</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>

                    {timetableEditMode && (
                        <div id="add-new-timetable-form-container" className="bg-gray-100 p-4 rounded-lg mb-6">
                            <h4 className="font-bold text-gray-800 mb-3">Add New Study Event</h4>
                            <div className="mb-3">
                                <label htmlFor="new-timetable-subject-input" className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" id="new-timetable-subject-input" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Anatomy" value={newSubject} onChange={(e) => setNewSubject(e.target.value)} />
                            </div>
                            <div className="mb-3">
                                <label htmlFor="new-timetable-topic" className="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                                <input type="text" id="new-timetable-topic" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Cardiovascular System" value={newTopic} onChange={(e) => setNewTopic(e.target.value)} />
                            </div>
                            <div className="mb-3">
                                <label htmlFor="new-timetable-date" className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="new-timetable-date" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={newDate} onChange={(e) => setNewDate(e.target.value)} />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="new-timetable-time" className="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                <input type="time" id="new-timetable-time" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={newTime} onChange={(e) => setNewTime(e.target.value)} />
                            </div>
                            <button onClick={handleAddEvent} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                Add Event
                            </button>
                        </div>
                    )}

                    <div id="timetable-events-list" className="space-y-4 bg-white p-2 rounded-lg min-h-[100px]">
                        {timetableEntries.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No study events scheduled. Click "Edit" to add some.</p>
                        ) : (
                            sortedDates.map(date => (
                                <React.Fragment key={date}>
                                    <div className="font-bold text-gray-800 mt-4 mb-2">{new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                    {/* Pass groupedEntries[date] as 'events' */}
                                    <TimetableEventCard events={groupedEntries[date]} isEditMode={timetableEditMode} onDelete={deleteTimetableEntry} />
                                </React.Fragment>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // TestCard Component
        const TestCard = ({ test, subject, isEditMode, onDelete }) => {
            return (
                <div id={`trophy-test-item-${subject}-${test.title}`} className="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <h4 className="font-semibold text-gray-800">{test.title}</h4>
                        <p className="text-sm text-gray-500 mt-1">{test.mcqs} MCQs</p>
                        <p className="text-xs text-gray-400 mt-1">Completed on {test.date}</p>
                    </div>
                    {isEditMode ? (
                        <button className="delete-trophy-test-btn text-red-500 hover:text-red-700 px-2 py-1 rounded-full text-sm font-medium" onClick={() => onDelete(subject, test.title)}>Delete</button>
                    ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    )}
                </div>
            );
        };


        // TestsCompletedPage Component
        const TestsCompletedPage = ({ testData, currentSelectedSubject, setCurrentSelectedSubject, addTest, deleteTest }) => {
            const { useState } = React;
            const [trophyEditMode, setTrophyEditMode] = useState(false);
            const [newTestTitle, setNewTestTitle] = useState('');
            const [newTestMcqs, setNewTestMcqs] = useState('');
            const [newTestDate, setNewTestDate] = useState('');

            const handleAddTest = () => {
                addTest(currentSelectedSubject, newTestTitle, newTestMcqs, newTestDate);
                setNewTestTitle('');
                setNewTestMcqs('');
                setNewTestDate('');
            };

            const subjects = Object.keys(testData);

            return (
                <div id="page-trophy" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-2">
                        <h1 className="text-3xl font-bold text-gray-900">Tests Completed</h1>
                        <button onClick={() => setTrophyEditMode(!trophyEditMode)} className="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            {trophyEditMode ? 'Done' : 'Edit'}
                        </button>
                    </header>
                    <p className="text-gray-500 mb-6">A peek into your previous test performances</p>

                    <div className="flex space-x-3 mb-6" id="subject-filters-container">
                        {subjects.map(subject => (
                            <button
                                key={subject}
                                className={`subject-filter flex-1 text-left p-3 rounded-lg ${currentSelectedSubject === subject ? 'bg-slate-600 text-white shadow' : 'bg-gray-100 text-gray-700'}`}
                                onClick={() => setCurrentSelectedSubject(subject)}
                            >
                                <p className="font-bold">{subject}</p>
                                <p className={`text-sm ${currentSelectedSubject === subject ? 'opacity-80' : 'text-gray-500'}`}>
                                    {testData[subject]?.length || 0} Test{testData[subject]?.length === 1 ? '' : 's'}
                                </p>
                            </button>
                        ))}
                    </div>

                    <div className="flex items-center gap-3 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="mb-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        <h3 id="subject-test-header" className="font-bold text-lg text-gray-800">{currentSelectedSubject} Tests</h3>
                    </div>

                    {trophyEditMode && (
                        <div id="add-new-test-form-container" className="bg-gray-100 p-4 rounded-lg mb-6">
                            <h4 className="font-bold text-gray-800 mb-3">Add New Test to <span id="current-subject-name-for-add">{currentSelectedSubject}</span></h4>
                            <div className="mb-3">
                                <label htmlFor="new-trophy-test-title" className="block text-sm font-medium text-gray-700 mb-1">Test Title</label>
                                <input type="text" id="new-trophy-test-title" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., New Test Name" value={newTestTitle} onChange={(e) => setNewTestTitle(e.target.value)} />
                            </div>
                            <div className="mb-3">
                                <label htmlFor="new-trophy-test-mcqs" className="block text-sm font-medium text-gray-700 mb-1">Number of MCQs</label>
                                <input type="number" id="new-trophy-test-mcqs" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 40" value={newTestMcqs} onChange={(e) => setNewTestMcqs(e.target.value)} />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="new-trophy-test-date" className="block text-sm font-medium text-gray-700 mb-1">Completion Date</label>
                                <input type="date" id="new-trophy-test-date" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={newTestDate} onChange={(e) => setNewTestDate(e.target.value)} />
                            </div>
                            <button onClick={handleAddTest} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                Add Test
                            </button>
                        </div>
                    )}

                    <div id="test-list-container" className="space-y-3">
                        {testData[currentSelectedSubject]?.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No tests available for {currentSelectedSubject}.</p>
                        ) : (
                            testData[currentSelectedSubject]?.map(test => (
                                <TestCard key={test.title} test={test} subject={currentSelectedSubject} isEditMode={trophyEditMode} onDelete={deleteTest} />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // AvailableTestCard for EditFocusPage
        const AvailableTestCard = ({ test, subject, isAdded, onAdd, onRemove }) => {
            const itemId = `${subject}-${test.title}`;
            const buttonText = isAdded ? 'Added' : 'Add';
            const buttonClasses = isAdded ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600';
            const itemOpacity = isAdded ? 'opacity-50' : '';

            return (
                <div id={`available-test-${itemId}`} className={`bg-gray-100 p-4 rounded-lg flex justify-between items-center ${itemOpacity}`}>
                    <div>
                        <h4 className="font-semibold text-gray-800">{test.title}</h4>
                        <p className="text-sm text-gray-500 mt-1">{test.mcqs} MCQs - {subject}</p>
                    </div>
                    <button
                        className={`text-white px-3 py-1 rounded-full text-sm transition duration-200 ${buttonClasses}`}
                        onClick={() => isAdded ? onRemove(itemId) : onAdd(test, subject)}
                        disabled={isAdded}
                    >
                        {buttonText}
                    </button>
                </div>
            );
        };


        // EditFocusPage Component
        const EditFocusPage = ({ testData, todayFocusItems, addFocusItem, removeFocusItem, onBackToDashboard }) => {
            const { useState } = React;
            const allTests = Object.keys(testData).flatMap(subject =>
                testData[subject].map(test => ({ ...test, subject, id: `${subject}-${test.title}` }))
            );

            return (
                <div id="page-edit-focus" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-2">
                        <h1 className="text-3xl font-bold text-gray-900">Edit Focus</h1>
                        <button onClick={onBackToDashboard} className="text-blue-600 hover:text-blue-800 text-sm font-medium">Done</button>
                    </header>
                    <p className="text-gray-500 mb-6">Select tests to add to your Today's Focus:</p>
                    <div id="available-tests-list" className="space-y-3 mb-8">
                        {allTests.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No tests available to add.</p>
                        ) : (
                            allTests.map(test => (
                                <AvailableTestCard
                                    key={test.id}
                                    test={test}
                                    subject={test.subject}
                                    isAdded={todayFocusItems.some(item => item.id === test.id)}
                                    onAdd={addFocusItem}
                                    onRemove={removeFocusItem}
                                />
                            ))
                        )}
                    </div>

                    <div className="mt-8 pt-4 border-t border-gray-200">
                        <h2 className="text-xl font-bold text-gray-900 mb-4">Tests in Today's Focus</h2>
                        <div id="current-focus-tests-ui" className="space-y-2">
                            {todayFocusItems.length === 0 ? (
                                <p className="text-gray-500 text-center w-full">No focus items for today.</p>
                            ) : (
                                todayFocusItems.map(item => (
                                    <div key={item.id} className="bg-blue-50 p-3 rounded-lg flex justify-between items-center">
                                        <div>
                                            <h4 className="font-semibold text-gray-800">{item.title}</h4>
                                            <p className="text-sm text-gray-500">{item.subject}</p>
                                        </div>
                                        <button className="remove-focus-item-quick-view text-red-500 hover:text-red-700 px-2 py-1 rounded-full text-sm font-medium" onClick={() => removeFocusItem(item.id)}>Remove</button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ManagedSubjectSection Component
        const ManagedSubjectSection = ({ subjectName, tests, onDeleteSubject, onDeleteTest }) => {
            return (
                <div className="bg-gray-100 p-4 rounded-lg shadow-sm mb-4">
                    <div className="flex justify-between items-center mb-3">
                        <h3 className="font-bold text-lg text-gray-800">{subjectName}</h3>
                        <button onClick={() => onDeleteSubject(subjectName)} className="delete-subject-btn bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600 transition duration-200">Delete Subject</button>
                    </div>
                    <div className="space-y-2">
                        {tests.length === 0 ? (
                            <p className="text-gray-500 text-sm italic">No tests in this subject.</p>
                        ) : (
                            tests.map(test => (
                                <div key={test.title} className="flex justify-between items-center bg-white p-3 rounded-md border border-gray-200 text-sm">
                                    <span>{test.title} ({test.mcqs} MCQs, {test.date})</span>
                                    <button onClick={() => onDeleteTest(subjectName, test.title)} className="delete-test-btn text-red-500 hover:text-red-700 font-medium ml-2">Delete</button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // ManageContentPage Component
        const ManageContentPage = ({ testData, addSubject, addTest, deleteSubject, deleteTest, onBackToProfile }) => {
            const { useState } = React;
            const [newSubjectName, setNewSubjectName] = useState('');
            const [selectedSubjectForTest, setSelectedSubjectForTest] = useState('');
            const [newTestTitle, setNewTestTitle] = useState('');
            const [newTestMcqs, setNewTestMcqs] = useState('');
            const [newTestDate, setNewTestDate] = useState('');

            const handleAddSubject = () => {
                addSubject(newSubjectName);
                setNewSubjectName('');
            };

            const handleAddTest = () => {
                addTest(selectedSubjectForTest, newTestTitle, newTestMcqs, newTestDate);
                setNewTestTitle('');
                setNewTestMcqs('');
                setNewTestDate('');
            };

            const subjects = Object.keys(testData);

            return (
                <div id="page-manage-tests" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-6">
                        <h1 className="text-3xl font-bold text-gray-900">Manage Content</h1>
                        <button onClick={onBackToProfile} className="text-blue-600 hover:text-blue-800 text-sm font-medium">Done</button>
                    </header>

                    <h2 className="text-xl font-bold text-gray-800 mb-4">Add New Subject</h2>
                    <div className="mb-8 p-4 bg-gray-100 rounded-lg">
                        <div className="mb-4">
                            <label htmlFor="new-subject-name" className="block text-sm font-medium text-gray-700 mb-1">Subject Name</label>
                            <input type="text" id="new-subject-name" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Biochemistry" value={newSubjectName} onChange={(e) => setNewSubjectName(e.target.value)} />
                        </div>
                        <button onClick={handleAddSubject} className="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                            Add Subject
                        </button>
                    </div>

                    <h2 className="text-xl font-bold text-gray-800 mb-4">Add New Test</h2>
                    <div className="mb-8 p-4 bg-gray-100 rounded-lg">
                        <div className="mb-4">
                            <label htmlFor="select-subject-for-test" className="block text-sm font-medium text-gray-700 mb-1">Select Subject</label>
                            <select id="select-subject-for-test" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={selectedSubjectForTest} onChange={(e) => setSelectedSubjectForTest(e.target.value)}>
                                <option value="">Select a Subject</option>
                                {subjects.map(subject => (
                                    <option key={subject} value={subject}>{subject}</option>
                                ))}
                            </select>
                        </div>
                        <div className="mb-4">
                            <label htmlFor="new-test-title" className="block text-sm font-medium text-gray-700 mb-1">Test Title</label>
                            <input type="text" id="new-test-title" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Carbohydrate Metabolism" value={newTestTitle} onChange={(e) => setNewTestTitle(e.target.value)} />
                        </div>
                        <div className="mb-4">
                            <label htmlFor="new-test-mcqs" className="block text-sm font-medium text-gray-700 mb-1">Number of MCQs</label>
                            <input type="number" id="new-test-mcqs" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 50" value={newTestMcqs} onChange={(e) => setNewTestMcqs(e.target.value)} />
                        </div>
                        <div className="mb-4">
                            <label htmlFor="new-test-date" className="block text-sm font-medium text-gray-700 mb-1">Completion Date</label>
                            <input type="date" id="new-test-date" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={newTestDate} onChange={(e) => setNewTestDate(e.target.value)} />
                        </div>
                        <button onClick={handleAddTest} className="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                            Add Test
                        </button>
                    </div>

                    <h2 className="text-xl font-bold text-gray-800 mb-4">Existing Content</h2>
                    <div id="manage-content-list" className="space-y-4">
                        {subjects.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No subjects available. Add a new subject above.</p>
                        ) : (
                            subjects.map(subject => (
                                <ManagedSubjectSection
                                    key={subject}
                                    subjectName={subject}
                                    tests={testData[subject]}
                                    onDeleteSubject={deleteSubject}
                                    onDeleteTest={deleteTest}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // ProfilePage Component
        const ProfilePage = ({ onManageContent, onLogout, currentUserId }) => {
            return (
                <div id="page-profile" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-6">
                        <h1 className="text-3xl font-bold text-gray-900">Profile</h1>
                    </header>
                    
                    <div className="flex items-center gap-4 bg-gray-100 p-4 rounded-xl mb-8">
                        <img src="https://placehold.co/80x80/E2E8F0/4A5568?text=AV" alt="User Avatar" className="w-16 h-16 rounded-full" />
                        <div>
                            <h2 className="font-bold text-xl text-gray-800">Alex Morgan</h2>
                            <p className="text-gray-500">alex.morgan@email.com</p>
                            <p className="text-sm text-gray-600 break-all">User ID: {currentUserId || 'Not authenticated'}</p> {/* Display User ID */}
                        </div>
                    </div>

                    <h3 className="font-bold text-lg text-gray-800 mb-4">Account</h3>
                    <div className="space-y-2">
                        <a href="#" className="flex justify-between items-center p-4 bg-gray-100 rounded-lg">
                            <span className="font-medium">Edit Profile</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </a>
                        <a href="#" className="flex justify-between items-center p-4 bg-gray-100 rounded-lg">
                            <span className="font-medium">Subscription</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </a>
                        <button onClick={onManageContent} className="flex justify-between items-center p-4 bg-gray-100 rounded-lg w-full text-left">
                            <span className="font-medium">Manage Tests & Subjects</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>
                    
                    <div className="mt-8">
                        <button onClick={onLogout} className="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300">
                            Logout
                        </button>
                    </div>
                </div>
            );
        };

        // BottomNavigation Component
        const BottomNavigation = ({ currentPage, onNavigate }) => {
            const navItems = [
                { page: 'dashboard', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> },
                { page: 'timetable', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg> },
                { page: 'trophy', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg> },
                { page: 'profile', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> },
            ];

            return (
                <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-20 bg-white border-t border-gray-200 flex justify-around items-center">
                    {navItems.map(item => (
                        <button
                            key={item.page}
                            onClick={() => onNavigate(item.page)}
                            className={`nav-btn p-2 ${currentPage === item.page ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            {item.icon}
                        </button>
                    ))}
                </nav>
            );
        };

        // Render the App component into the 'root' div, wrapped in ErrorBoundary
        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
