<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Education Dashboard Self-Contained HTML Application" />
    <title>Education Dashboard</title>

    <!-- PWA: Link to manifest.json -->
    <link rel="manifest" href="/manifest.json">

    <!-- Tailwind CSS CDN - Retained as per your "no build" request -->
    <script src="https://cdn.tailwindcss.com"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Josefin+Sans&amp;family=Kalnia:wght@600&amp;family=Lemon&amp;family=Raleway:wght@700&amp;family=Tilt+Prism&amp;display=swap"
        rel="stylesheet">
    <style>
        /* Base styles - Retained as per your "no build" request */
        body {
            font-family: 'Inter', Josefin Sans;
            -webkit-tap-highlight-color: transparent;
            /* Disable tap highlight on mobile */
            background-color: #f9fafb;
            /* Light gray background */
            color: #1f2937;
            /* Darker text for readability */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Hide scrollbar for webkit browsers */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* General page styling - ensures pages fill content area */
        .page {
            min-height: calc(100vh - 80px);
            /* Adjust based on your header/footer height */
            padding-bottom: 5rem;
            /* Space for bottom navigation */
        }

        /* Ensure the main container accounts for fixed bottom nav */
        #main-content {
            padding-bottom: 5rem;
            /* Adjust if bottom nav height changes */
        }

        /* For the fixed notification message to be visible */
        .z-50 {
            z-index: 9999;
        }

        /* Ensure smooth transitions for page content changes */
        .page-transition {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 transition-colors duration-300">
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"
        class="w-full max-w-md mx-auto bg-white min-h-screen shadow-lg relative overflow-hidden transition-colors duration-300">
    </div>

    <!-- React, ReactDOM, and Babel for client-side JSX compilation - Retained as per your "no build" request -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs - Kept as type="module" as they are standard ES modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // Corrected import for firestore module to access enablePersistence
        import * as firestoreModule from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IMPORTANT: Replace the following firebaseConfig with YOUR OWN Firebase project configuration!
        // You can find this in your Firebase project settings -> Project settings -> General -> Your apps (Web app)
        const firebaseConfig = {
            apiKey: "AIzaSyAHowpOHnCOaQ5eackHV__Bo3M42437lXQ",
            authDomain: "daily-discussion-1040d.firebaseapp.com",
            projectId: "daily-discussion-1040d",
            storageBucket: "daily-discussion-1040d.firebasestorage.app",
            messagingSenderId: "647593805968",
            appId: "1:647593805968:web:321f52517221267163f015",
            measurementId: "G-YB5N6Q6MDZ"
        };

        try {
            const app = initializeApp(firebaseConfig);
            // Access getFirestore from the imported firestoreModule
            const db = firestoreModule.getFirestore(app);
            const auth = getAuth(app);

            // Enable Firebase Firestore offline persistence
            // Disabled: enablePersistence is not available in CDN ES module version.
            // firestoreModule.enablePersistence(db)
            //     .then(() => {
            //         console.log("Firestore persistence enabled successfully!");
            //     })
            //     .catch((err) => {
            //         if (err.code === 'failed-precondition') {
            //             // Multiple tabs open, persistence can only be enabled in one tab.
            //             console.warn("Firestore persistence failed: multiple tabs open. This is normal if you have multiple instances of the app open.");
            //         } else if (err.code === 'unimplemented') {
            //             // The current browser does not support all of the features required to enable persistence.
            //             console.error("Firestore persistence failed: browser not supported. Please use a modern browser.");
            //         } else {
            //             console.error("Error enabling Firestore persistence:", err);
            //         }
            //     });

            // Expose Firebase objects and functions globally for React components
            window.firebaseApp = app;
            window.db = db;
            window.auth = auth;
            window.signOut = signOut; // Expose signOut

            // Expose ALL necessary Firestore specific functions from the module
            window.doc = firestoreModule.doc;
            window.setDoc = firestoreModule.setDoc;
            window.deleteDoc = firestoreModule.deleteDoc;
            window.onSnapshot = firestoreModule.onSnapshot;
            window.collection = firestoreModule.collection;
            window.query = firestoreModule.query;
            window.getDoc = firestoreModule.getDoc;
            window.getDocs = firestoreModule.getDocs;
            window.addDoc = firestoreModule.addDoc; // Expose addDoc
            window.where = firestoreModule.where; // Expose where for queries
            window.writeBatch = firestoreModule.writeBatch; // Expose writeBatch method

            // Set up global __app_id for data paths (using projectId as a common app identifier)
            window.__app_id = firebaseConfig.projectId;

            console.log("Firebase SDKs initialized successfully in script module.");

        } catch (error) {
            console.error("Error initializing Firebase SDKs:", error);
            // Optionally display a global error message if Firebase init fails completely
            document.getElementById('root').innerHTML = `
                <div style="text-align: center; padding: 20px; color: red;">
                    <h3>Error loading application!</h3>
                    <p>Firebase initialization failed. Please check your console for details.</p>
                    <p>${error.message}</p>
                </div>
            `;
        }

        // PWA: Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>

    <!-- Main application JavaScript with React components and JSX -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- COMMON COMPONENTS (Defined here to make all pages functional) ---

        // ErrorBoundary component to catch rendering errors
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                this.setState({
                    error: error,
                    errorInfo: errorInfo
                });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-red-100 text-red-800 p-4 rounded-lg shadow-md">
                            <h1 className="text-xl font-bold mb-2">Oops! Something went wrong.</h1>
                            <p className="text-sm text-center mb-4">
                                We're sorry for the inconvenience. Please try refreshing the page.
                            </p>
                            {this.state.error && (
                                <details className="mt-4 p-2 bg-red-200 rounded-md text-xs text-red-900 overflow-auto max-h-40">
                                    <summary>Error Details</summary>
                                    <pre>{this.state.error.toString()}</pre>
                                    <pre>{this.state.errorInfo.componentStack}</pre>
                                </details>
                            )}
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Notification Component
        const NotificationMessage = React.memo(({ message, type, onClose }) => {
            let bgColor = '';
            let textColor = '';
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    break;
                case 'info':
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    break;
                default:
                    bgColor = 'bg-gray-700';
                    textColor = 'text-white';
            }

            return (
                <div className={`fixed bottom-4 left-1/2 transform -translate-x-1/2 ${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ease-out`}
                    style={{ minWidth: '200px', maxWidth: '90%' }}>
                    <div className="flex items-center justify-between">
                        <span>{message}</span>
                        <button onClick={onClose} className="ml-4 text-white hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
            );
        });

        // LoadingSpinner Component
        const LoadingSpinner = React.memo(() => (
            <div className="flex flex-col items-center justify-center min-h-screen text-gray-500">
                <svg className="animate-spin h-8 w-8 text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>Loading...</p>
            </div>
        ));

        // LoginPage Component
        const LoginPage = React.memo(({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(username, password);
            };

            return (
                <div id="login-page" className="flex flex-col items-center justify-center min-h-screen px-6 py-8">
                    <div className="w-full">
                        <div className="text-center mb-12">
                            <svg xmlns="http://www.w3.org/2000/svg" className="mx-auto h-12 w-auto text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 21h7a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2Z"></path><path d="M12 18a2 2 0 0 0 0-4 2 2 0 0 0 0 4Z"></path><path d="M12 10V6"></path></svg>
                            <h1 className="text-3xl font-bold text-gray-900 mt-4">Welcome Back!</h1>
                            <p className="text-gray-500 mt-2">Sign in to continue your progress.</p>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label htmlFor="username" className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="username" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your username" value={username} onChange={(e) => setUsername(e.target.value)} />
                            </div>
                            <div className="mb-6">
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="password" className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value={password} onChange={(e) => setPassword(e.target.value)} />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                Login
                            </button>
                        </form>
                        <p className="text-center text-sm text-gray-500 mt-6">
                            Don't have an account? <a href="#" className="font-medium text-blue-600 hover:underline">Sign up</a>
                        </p>
                    </div>
                </div>
            );
        });

        // Greeting Component
        const Greeting = React.memo(({ userName }) => {
            const [greetingText, setGreetingText] = useState('');
            const [greetingEmoji, setGreetingEmoji] = useState('');

            useEffect(() => {
                const updateGreeting = () => {
                    const hour = new Date().getHours();
                    let text = '';
                    let emoji = '';

                    if (hour >= 5 && hour < 12) {
                        text = 'Good morning';
                        emoji = 'â˜€ï¸';
                    } else if (hour >= 12 && hour < 17) {
                        text = 'Good afternoon';
                        emoji = 'ðŸ‘‹';
                    } else if (hour >= 17 && hour < 22) {
                        text = 'Good evening';
                        emoji = 'ðŸŒ™';
                    } else {
                        text = 'Time to sleep';
                        emoji = 'ðŸ˜´';
                    }
                    setGreetingText(text);
                    setGreetingEmoji(emoji);
                };

                updateGreeting();
                const intervalId = setInterval(updateGreeting, 60 * 1000);
                return () => clearInterval(intervalId);
            }, []);

            return (
                <div>
                    <p className="text-sm font-light text-gray-500 flex items-center">
                        {greetingText}<span className="ml-1 text-base">{greetingEmoji}</span>
                    </p>
                </div>
            );
        });

        // StatCard Component
        const StatCard = React.memo(({ category, value, icon }) => {
            return (
                <div className="bg-[#FEFBF2] p-4 rounded-xl flex flex-col items-start justify-center text-left">
                    {React.cloneElement(icon, { className: `mb-2 text-gray-600 ${icon.props.className || ''}` })}
                    <p className="text-3xl font-bold mt-2">{value}</p>
                    <p className="text-sm text-gray-600 mt-1">{category}</p>
                </div>
            );
        });

        // FocusItemCard Component - UPDATED for consistent checkmark style and trash icon
        const FocusItemCard = React.memo(({ item, onRemove, onMoveUp, onMoveDown, isFirst, isLast, allowReorder, handleToggleTestCompletion }) => {
            const handleCardClick = () => {
                if (item.link && item.link.startsWith('http')) {
                    window.open(item.link, '_blank');
                } else if (item.link) {
                    console.warn(`Invalid link for ${item.title}: ${item.link}. Must start with http:// or https://`);
                }
            };
            // Modified to handle checkbox as a button for consistent styling
            const handleCheckboxClick = (e) => {
                e.stopPropagation(); // Prevent card click from triggering
                handleToggleTestCompletion(item.subject, item.title, !item.completed);
            };

            const cardClasses = `
                relative flex-shrink-0 w-full p-4 rounded-xl border transition-all duration-300 ease-in-out
                ${item.completed ? 'bg-green-50 border-green-200' : 'bg-gray-100 border-gray-200'}
                cursor-pointer hover:shadow-md
            `;
            return (
                <div id={`focus-item-${item.id}`} className={cardClasses} onClick={handleCardClick}>
                    <div className="flex items-start flex-grow pr-16">
                        {/* Replaced input checkbox with a styled button/svg for consistency */}
                        <button
                            onClick={handleCheckboxClick}
                            className={`w-6 h-6 rounded-full border-2 ${item.completed ? "bg-green-500 border-green-500" : "border-gray-300"} mr-3 flex-shrink-0 mt-0.5`}
                            aria-label={item.completed ? "Mark as incomplete" : "Mark as complete"}
                        >
                            {item.completed && (
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    className="h-4 w-4 text-white m-auto"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                </svg>
                            )}
                        </button>
                        <div className="flex-shrink-0 mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="mt-0.5">
                                <path d={item.iconPath || "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm13 14v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"}></path>
                            </svg>
                        </div>
                        <div>
                            <h3 className="font-semibold text-gray-800 leading-tight">{item.title}</h3>
                            <div className="flex items-center mt-1 text-sm">
                                <span className="text-gray-500">({item.mcqs} MCQs)</span>
                            </div>
                        </div>
                    </div>
                    {allowReorder && (
                        <div className="absolute top-2 right-2 flex flex-col items-center space-y-1">
                            <button
                                onClick={(e) => { e.stopPropagation(); onMoveUp(); }}
                                disabled={isFirst}
                                className="p-1.5 rounded-full text-gray-500 hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed transition-colors duration-200"
                                aria-label="Move up"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                            </button>
                            <button
                                onClick={(e) => { e.stopPropagation(); onMoveDown(); }}
                                disabled={isLast}
                                className="p-1.5 rounded-full text-gray-500 hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed transition-colors duration-200"
                                aria-label="Move down"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    )}
                    {!allowReorder && (
                        <button className="absolute top-2 right-2 p-1.5 rounded-full text-gray-400 hover:text-red-500 transition-colors duration-200" onClick={(e) => { e.stopPropagation(); onRemove(item.id); }} aria-label="Remove from focus">
                            {/* Replaced 'x' icon with trash icon */}
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    )}
                </div>
            );
        });

        // DashboardPage Component - Now receives isLoadingTodayFocus
        const DashboardPage = React.memo(({ testData, todayFocusItems, onEditFocus, removeFocusItem, onNavigate, userName, userEmail, currentUserId, handleToggleTestCompletion, isLoadingTodayFocus }) => {
            const [stats, setStats] = useState({ days: 0, mcqs: 0, tests: 0, subjects: 0 });

            useEffect(() => {
                let uniqueDates = new Set();
                let totalMCQs = 0;
                let totalTests = 0;
                let uniqueSubjects = new Set();

                for (const subject in testData) {
                    if (testData.hasOwnProperty(subject)) {
                        if (testData[subject].length > 0) {
                            uniqueSubjects.add(subject);
                        }
                        testData[subject].forEach(test => {
                            totalTests++;
                            totalMCQs += test.mcqs;
                            uniqueDates.add(test.date);
                        });
                    }
                }
                setStats({
                    days: uniqueDates.size,
                    mcqs: totalMCQs,
                    tests: totalTests,
                    subjects: uniqueSubjects.size
                });
            }, [testData]);

            return (
                <div id="page-dashboard" className="page px-6 py-8">
                    <div
                        className="flex items-center gap-4 bg-gray-100 p-4 rounded-xl mb-8 cursor-pointer transition-colors duration-300"
                        onClick={() => onNavigate('profile')}
                    >
                        <img src="https://placehold.co/80x80/E2E8F0/4A5568?text=NK" alt="User Avatar" className="w-16 h-16 rounded-full" />
                        <div>
                            <h2 className="font-bold text-xl text-gray-800">Welcome {userName || 'User'}</h2>
                            <Greeting userName={userName || 'User'} />
                            <p className="text-sm text-600 break-all">User ID: {currentUserId || 'Not authenticated'}</p>
                        </div>
                    </div>

                    <hr className="my-6 border-t border-gray-200" />

                    <header className="flex items-center justify-between mb-2">
                        <h1 className="text-xl font-bold text-gray-900">Dashboard</h1>
                        </header>
                    <p className="text-gray-500 mb-8">Your progress at a glance...</p>
                    <div className="grid grid-cols-2 gap-4 mb-10">
                        <StatCard
                            category="Days"
                            value={stats.days}
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>}

                        />
                        <StatCard
                            category="MCQs"
                            value={stats.mcqs}
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><path d="m19 21-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>}
                        />
                        <StatCard
                            category="Tests"
                            value={stats.tests}
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>}
                        />
                        <StatCard
                            category="Subjects"
                            value={stats.subjects}
                            icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2 text-gray-600"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>}
                        />
                    </div>
                    <div>

                        <hr className="my-6 border-t border-gray-200" />

                        <header className="flex items-center justify-between py-2">
                            <h2 className="text-xl font-bold text-gray-900">Today's Focus</h2>
                            <button onClick={onEditFocus} className="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit Focus</button>
                        </header>
                        <p className="text-gray-500 mb-6">Your tests today...</p>
                        <div id="today-focus-container" className="flex flex-col space-y-4 pb-4">
                            {/* Use isLoadingTodayFocus for DashboardPage as well */}
                            {isLoadingTodayFocus ? (
                                <LoadingSpinner />
                            ) : todayFocusItems.length === 0 ? (
                                <p className="text-gray-500 text-center w-full">No focus items for today. Click "Edit Focus" to add some.</p>
                            ) : (
                                todayFocusItems.map(item => (
                                    <FocusItemCard
                                        key={item.id}
                                        item={item}
                                        onRemove={removeFocusItem}
                                        handleToggleTestCompletion={handleToggleTestCompletion}
                                        allowReorder={false}
                                    />
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        });

        // CircularProgressBar Component
        const CircularProgressBar = React.memo(({ percentage }) => {
            const radius = 15.9155;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;

            return (
                <div className="relative w-20 h-20">
                    <svg className="w-full h-full" viewBox="0 0 36 36">
                        <path className="text-green-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" strokeWidth="3" stroke="currentColor" />
                        <path
                            className="progress-ring__circle text-green-500"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            strokeWidth="3"
                            strokeLinecap="round"
                            stroke="currentColor"
                            style={{ strokeDasharray: `${circumference} ${circumference}`, strokeDashoffset: offset }}
                        />
                    </svg>
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold text-green-600">{Math.round(percentage)}%</div>
                </div>
            );
        });

        // TimetableEventCard Component with calendar strip and checkmark - UPDATED
        const TimetableEventCard = React.memo(({ events, isEditMode, onDelete, onCheck, selectedCalendarDate, onSelectCalendarDate }) => {
            const sortedEvents = React.useMemo(() => {
                // Sort events by time for consistent display
                return [...events].sort((a, b) => a.time.localeCompare(b.time));
            }, [events]);

            // Helper function to generate dates for the week containing the baseDate
            const getWeekDates = useCallback((baseDate) => {
                const weekDates = [];
                const startOfWeek = new Date(baseDate);
                // Set to Sunday of the current week (0 = Sunday, 1 = Monday, etc.)
                startOfWeek.setDate(baseDate.getDate() - baseDate.getDay());

                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    weekDates.push(date);
                }
                return weekDates;
            }, []);

            const weekDates = getWeekDates(selectedCalendarDate);

            // Helper function to format date for display (e.g., "28 Thu")
            const formatDateForDisplay = (date) => {
                const day = date.getDate();
                const options = { weekday: 'short' };
                const dayName = date.toLocaleDateString('en-US', options);
                return `${day} ${dayName}`;
            };

            // Helper function to compare dates without time (YYYY-MM-DD)
            const toDateString = (date) => date.toISOString().split('T')[0];

            // Helper function to check if a given date is today (actual current date)
            const isActualToday = (date) => {
                const today = new Date();
                return toDateString(date) === toDateString(today);
            };

            const handlePrevWeek = () => {
                const newDate = new Date(selectedCalendarDate);
                newDate.setDate(newDate.getDate() - 7);
                onSelectCalendarDate(newDate);
            };

            const handleNextWeek = () => {
                const newDate = new Date(selectedCalendarDate);
                newDate.setDate(newDate.getDate() + 7);
                onSelectCalendarDate(newDate);
            };

            const currentMonthYear = selectedCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            return (
                <div className="w-full">
                    {/* Header for month/year and navigation buttons */}
                    <div className="flex items-center justify-between px-2 py-2 text-gray-700 font-semibold text-lg">
                        <button onClick={handlePrevWeek} className="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <span className="flex-grow text-center">{currentMonthYear}</span>
                        <button onClick={handleNextWeek} className="p-2 rounded-full hover:bg-gray-100 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>

                    {/* Calendar strip for the week - added no-scrollbar */}
                    <div className="flex justify-between overflow-x-auto px-2 py-4 no-scrollbar">
                        {weekDates.map((date, index) => {
                            const isSelected = toDateString(date) === toDateString(selectedCalendarDate);
                            const isToday = isActualToday(date);
                            let buttonClasses = "flex flex-col items-center px-3 py-2 rounded-lg transition-colors duration-200 flex-1 mx-0.5";

                            if (isToday && isSelected) {
                                buttonClasses += " bg-blue-600 text-white shadow-md";
                            } else if (isToday) {
                                buttonClasses += " bg-blue-300 text-blue-800"; // Light blue for actual today if not selected
                            } else if (isSelected) {
                                buttonClasses += " bg-blue-500 text-white shadow-md"; // Blue for selected date
                            } else {
                                buttonClasses += " text-gray-600 hover:bg-gray-100";
                            }

                            return (
                                <button
                                    key={index}
                                    onClick={() => onSelectCalendarDate(date)} // Select this specific day
                                    className={buttonClasses}
                                >
                                    <span className="text-sm font-medium">{formatDateForDisplay(date).split(" ")[0]}</span>
                                    <span className="text-xs">{formatDateForDisplay(date).split(" ")[1]}</span>
                                </button>
                            );
                        })}
                    </div>

                    {/* Events list */}
                    {sortedEvents.length === 0 ? (
                        <p className="text-gray-500 text-center py-4">No events scheduled for this date.</p>
                    ) : (
                        sortedEvents.map(item => (
                            <div
                                key={item.id}
                                className={`flex justify-between items-center p-4 mb-3 rounded-xl shadow-sm ${item.checked ? "bg-green-100" : "bg-white"}`}
                            >
                                <div>
                                    <p className="text-xs text-gray-500">{item.time}</p>
                                    <h4 className="font-semibold text-gray-800">{item.topic}</h4>
                                    <p className="text-sm text-gray-600">{item.subject}</p>
                                </div>
                                <div className="flex items-center">
                                    {isEditMode && (
                                        <button
                                            onClick={() => onDelete(item.id)}
                                            className="p-1.5 rounded-full text-gray-400 hover:text-red-500 transition-colors duration-200 mr-2"
                                            aria-label="Delete event"
                                        >
                                            {/* Trash icon for delete */}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                        </button>
                                    )}
                                    <button
                                        onClick={() => onCheck(item.id)}
                                        className={`w-6 h-6 rounded-full border-2 ${item.checked ? "bg-green-500 border-green-500" : "border-gray-300"}`}
                                    >
                                        {item.checked && (
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                className="h-4 w-4 text-white m-auto"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                            </svg>
                                        )}
                                    </button>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            );
        });

        // TimetablePage Component - UPDATED to handle checkmark functionality and date selection
        const TimetablePage = React.memo(({ timetableEntries, testData, currentTimetableSubject, setCurrentTimetableSubject, setCurrentSelectedSubject, addTimetableEntry, deleteTimetableEntry, navigateToTrophyPage, showNotification, userId }) => {
            const [timetableEditMode, setTimetableEditMode] = useState(false);
            const [newSubject, setNewSubject] = useState('');
            const [newTopic, setNewTopic] = useState('');
            const [newDate, setNewDate] = useState('');
            const [newTime, setNewTime] = useState('');
            const [selectedDisplayDate, setSelectedDisplayDate] = useState(new Date()); // New state for selected date to display events for


            const handleAddEvent = () => {
                addTimetableEntry(newSubject, newTopic, newDate, newTime);
                setNewSubject('');
                setNewTopic('');
                setNewDate('');
                setNewTime('');
            };

            const handleCheckEvent = useCallback(async (eventId) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                try {
                    const timetableEntryDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "timetable", eventId);
                    const entryDoc = await window.getDoc(timetableEntryDocRef);

                    if (entryDoc.exists()) {
                        const currentCheckedStatus = entryDoc.data().checked || false;
                        await window.setDoc(timetableEntryDocRef, { checked: !currentCheckedStatus }, { merge: true });
                        showNotification(`Timetable event marked as ${!currentCheckedStatus ? 'completed' : 'incomplete'}.`, 'success');
                    } else {
                        showNotification('Timetable entry not found.', 'error');
                    }
                } catch (error) {
                    console.error("Error toggling timetable event completion:", error);
                    showNotification("Failed to update timetable event status.", 'error');
                }
            }, [userId, showNotification]);


            const subjects = Object.keys(testData);

            const calculateProgress = useCallback(() => {
                const subjectTests = testData[currentTimetableSubject] || [];
                const totalTests = subjectTests.length;
                const completedTests = subjectTests.filter(test => test.completed).length;
                return totalTests > 0 ? (completedTests / totalTests) * 100 : 0;
            }, [currentTimetableSubject, testData]);

            const progressPercentage = calculateProgress();
            const completedCount = testData[currentTimetableSubject] ? testData[currentTimetableSubject].filter(test => test.completed).length : 0;
            const totalCount = testData[currentTimetableSubject] ? testData[currentTimetableSubject].length : 0;

            // Filter timetable entries for the selected calendar date
            const eventsForSelectedDate = React.useMemo(() => {
                const selectedDateString = selectedDisplayDate.toISOString().split('T')[0];
                return timetableEntries.filter(entry => entry.date === selectedDateString);
            }, [timetableEntries, selectedDisplayDate]);

            // Group all entries by date for display (even if only one day's events are shown below)
            const groupedEntries = timetableEntries.reduce((acc, entry) => {
                const date = entry.date;
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(entry);
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedEntries).sort((a, b) => new Date(a) - new Date(b));


            return (
                <div id="page-timetable" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-2">
                        <h1 className="text-3xl font-bold text-gray-900">Timetable</h1>
                        <button onClick={() => setTimetableEditMode(!timetableEditMode)} className="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            {timetableEditMode ? 'Done' : 'Edit'}
                        </button>
                    </header>
                    <p className="text-gray-500 mb-6">Upcoming Study Schedule</p>

                    <div className="mb-6">
                        <label htmlFor="select-timetable-subject" className="block text-sm font-medium text-gray-700 mb-1">Track Progress for Subject:</label>
                        <select
                            id="select-timetable-subject"
                            className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={currentTimetableSubject}
                            onChange={(e) => {
                                const newSubject = e.target.value;
                                setCurrentTimetableSubject(newSubject);
                                setCurrentSelectedSubject(newSubject);
                                localStorage.setItem('currentTimetableSubject', newSubject); // Persist selection
                            }}
                            disabled={subjects.length === 0}
                        >
                            {subjects.length === 0 && <option value="">No Subjects Available</option>}
                            {subjects.map(subject => (
                                <option key={subject} value={subject}>{subject}</option>
                            ))}
                        </select>
                    </div>

                    <div id="timetable-progress-card" onClick={() => navigateToTrophyPage(currentTimetableSubject)} className="bg-green-50 p-5 rounded-2xl flex items-center justify-between mb-8 cursor-pointer transition-colors duration-300">
                        <CircularProgressBar percentage={progressPercentage} />
                        <div className="flex-1 ml-4">
                            <p className="text-sm text-gray-500">Subject</p>
                            <p id="timetable-progress-subject" className="text-xl font-bold text-gray-800">{currentTimetableSubject || 'Select Subject'}</p>
                            <p className="text-sm text-gray-500 mt-1">Tests Completed</p>
                            <p className="text-lg font-bold text-gray-800">{completedCount}/{totalCount}</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>

                    {timetableEditMode && (
                        <div id="add-new-timetable-form-container" className="bg-gray-100 p-4 rounded-lg mb-6">
                            <h4 className="font-bold text-gray-800 mb-3">Add New Study Event</h4>
                            <div className="mb-3">
                                <label htmlFor="new-timetable-subject-input" className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" id="new-timetable-subject-input" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Anatomy" value={newSubject} onChange={(e) => setNewSubject(e.target.value)} />
                            </div>
                            <div className="mb-3">
                                <label htmlFor="new-timetable-topic" className="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                                <input type="text" id="new-timetable-topic" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Cardiovascular System" value={newTopic} onChange={(e) => setNewTopic(e.target.value)} />
                            </div>
                            <div className="mb-3">
                                <label htmlFor="new-timetable-date" className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="new-timetable-date" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={newDate} onChange={(e) => setNewDate(e.target.value)} />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="new-timetable-time" className="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                <input type="time" id="new-timetable-time" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={newTime} onChange={(e) => setNewTime(e.target.value)} />
                            </div>
                            <button onClick={handleAddEvent} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                Add Event
                            </button>
                        </div>
                    )}

                    <div id="timetable-events-list" className="space-y-4 bg-white p-2 rounded-lg min-h-[100px]">
                        <TimetableEventCard
                            events={eventsForSelectedDate}
                            isEditMode={timetableEditMode}
                            onDelete={deleteTimetableEntry}
                            onCheck={handleCheckEvent}
                            selectedCalendarDate={selectedDisplayDate}
                            onSelectCalendarDate={setSelectedDisplayDate}
                        />
                    </div>
                </div>
            );
        });

        // TestCard Component - UPDATED for consistent checkmark style and trash icon
        const TestCard = React.memo(({ test, subject, isEditMode, onDelete, handleToggleTestCompletion }) => {
            const handleCardClick = () => {
                if (!isEditMode && test.link && test.link.startsWith('http')) {
                    window.open(test.link, '_blank');
                } else if (test.link) {
                    console.warn(`Invalid link for ${test.title}: ${test.link}. Must start with http:// or https://`);
                }
            };

            // Modified to handle checkbox as a button for consistent styling
            const handleCheckboxClick = (e) => {
                e.stopPropagation(); // Prevent card click from triggering
                handleToggleTestCompletion(subject, test.title, !test.completed);
            };

            const cardClasses = `
                relative bg-gray-100 p-4 rounded-lg flex justify-between items-center transition-colors duration-300
                ${test.completed ? 'bg-green-50 border border-green-200' : 'border border-gray-200'}
                ${test.link && !isEditMode ? 'cursor-pointer hover:shadow-md' : ''}
            `;

            return (
                <div
                    id={`trophy-test-item-${subject}-${test.title}`}
                    className={cardClasses}
                    onClick={handleCardClick}
                >
                    <div className="flex items-center flex-grow">
                        {/* Replaced input checkbox with a styled button/svg for consistency */}
                        <button
                            onClick={handleCheckboxClick}
                            className={`w-6 h-6 rounded-full border-2 ${test.completed ? "bg-green-500 border-green-500" : "border-gray-300"} mr-3`}
                            aria-label={test.completed ? "Mark as incomplete" : "Mark as complete"}
                        >
                            {test.completed && (
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    className="h-4 w-4 text-white m-auto"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                </svg>
                            )}
                        </button>
                        <div>
                            <h4 className="font-semibold text-gray-800">{test.title}</h4>
                            <p className="text-sm text-gray-500 mt-1">{test.mcqs} MCQs</p>
                            <p className="text-xs text-gray-400 mt-1">Completed on {test.date}</p>
                        </div>
                    </div>
                    {isEditMode && (
                        <button
                            className="absolute top-2 right-2 p-1.5 rounded-full text-gray-400 hover:text-red-500 transition-colors duration-200"
                            onClick={(e) => { e.stopPropagation(); onDelete(subject, test.title); }}
                            aria-label="Delete test"
                        >
                            {/* Trash icon for delete */}
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    )}
                    {!isEditMode && (
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    )}
                </div>
            );
        });

        const TestsCompletedPage = React.memo(({ testData, currentSelectedSubject, setCurrentSelectedSubject, addTest, deleteTest, handleToggleTestCompletion }) => {
            const [trophyEditMode, setTrophyEditMode] = useState(false);
            const [newTestTitle, setNewTestTitle] = useState('');
            const [newTestMcqs, setNewTestMcqs] = useState('');
            const [newTestDate, setNewTestDate] = useState('');
            const [newTestLink, setNewTestLink] = useState('');
            const [searchQuery, setSearchQuery] = useState('');

            const handleAddTest = () => {
                addTest(currentSelectedSubject, newTestTitle, newTestMcqs, newTestDate, newTestLink);
                setNewTestTitle('');
                setNewTestMcqs('');
                setNewTestDate('');
                setNewTestLink('');
            };

            const subjects = Object.keys(testData);

            const filteredTests = currentSelectedSubject && testData[currentSelectedSubject]
                ? testData[currentSelectedSubject].filter(test =>
                    test.title.toLowerCase().includes(searchQuery.toLowerCase())
                )
                : [];

            return (
                <div id="page-trophy" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-2">
                        <h1 className="text-3xl font-bold text-gray-900">Tests</h1>
                        <button onClick={() => setTrophyEditMode(!trophyEditMode)} className="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            {trophyEditMode ? 'Done' : 'Edit'}
                        </button>
                    </header>
                    <p className="text-gray-500 mb-6">Completed Tests & Progress</p>

                    <div className="mb-6">
                        <input
                            type="text"
                            placeholder="Search tests..."
                            className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>

                    <div className="flex space-x-3 mb-6 overflow-x-auto no-scrollbar" id="subject-filters-container">
                        {subjects.map(subject => (
                            <button
                                key={subject}
                                className={`subject-filter flex-shrink-0 text-left p-3 rounded-lg transition-colors duration-200
                                ${currentSelectedSubject === subject ? 'bg-blue-600 text-white shadow' : 'bg-gray-100 text-gray-700'}`}
                                onClick={() => setCurrentSelectedSubject(subject)}
                            >
                                <p className="font-bold">{subject}</p>
                                <p className={`text-sm ${currentSelectedSubject === subject ? 'opacity-80' : 'text-gray-500'}`}>
                                    {testData[subject]?.length || 0} Test{testData[subject]?.length === 1 ? '' : 's'}
                                </p>
                            </button>
                        ))}
                    </div>

                    <div className="flex items-center gap-3 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="mb-3"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        <h3 id="subject-test-header" className="font-bold text-lg text-gray-800">{currentSelectedSubject} Tests</h3>
                    </div>

                    {trophyEditMode && (
                        <div id="add-new-test-form-container" className="bg-gray-100 p-4 rounded-lg mb-6">
                            <h4 className="font-bold text-gray-800 mb-3">Add New Test to <span id="current-subject-name-for-add">{currentSelectedSubject}</span></h4>
                            <div className="mb-3">
                                <label htmlFor="new-trophy-test-title" className="block text-sm font-medium text-gray-700 mb-1">Test Title</label>
                                <input type="text" id="new-trophy-test-title" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., New Test Name" value={newTestTitle} onChange={(e) => setNewTestTitle(e.target.value)} />
                            </div>
                            <div className="mb-3">
                                <label htmlFor="new-trophy-test-mcqs" className="block text-sm font-medium text-gray-700 mb-1">Number of MCQs</label>
                                <input type="number" id="new-trophy-test-mcqs" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 40" value={newTestMcqs} onChange={(e) => setNewTestMcqs(e.target.value)} />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="new-trophy-test-date" className="block text-sm font-medium text-gray-700 mb-1">Completion Date</label>
                                <input type="date" id="new-trophy-test-date" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={newTestDate} onChange={(e) => setNewTestDate(e.target.value)} />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="new-trophy-test-link" className="block text-sm font-medium text-gray-700 mb-1">Test Link (Optional)</label>
                                <input type="url" id="new-trophy-test-link" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., https://example.com/test" value={newTestLink} onChange={(e) => setNewTestLink(e.target.value)} />
                            </div>
                            <button onClick={handleAddTest} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                                Add Test
                            </button>
                        </div>
                    )}

                    <div id="test-list-container" className="space-y-3">
                        {filteredTests.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No tests available for {currentSelectedSubject} matching your search.</p>
                        ) : (
                            filteredTests.map(test => (
                                <TestCard
                                    key={test.title}
                                    test={test}
                                    subject={currentSelectedSubject}
                                    isEditMode={trophyEditMode}
                                    onDelete={deleteTest}
                                    handleToggleTestCompletion={handleToggleTestCompletion}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        });

        // AvailableTestCard for EditFocusPage - UPDATED for consistent checkmark style
        const AvailableTestCard = React.memo(({ test, subject, isAdded, onAdd, onRemove, handleToggleTestCompletion }) => {
            const localTempId = `${subject}-${test.title}`;

            // Modified to handle checkbox as a button for consistent styling
            const handleCheckboxClick = (e) => {
                e.stopPropagation(); // Prevent card click from triggering
                handleToggleTestCompletion(subject, test.title, !test.completed);
            };

            const cardClasses = `
                bg-gray-100 p-4 rounded-lg flex justify-between items-center transition-colors duration-300
                ${test.completed ? 'bg-green-50 border border-green-200' : 'border border-gray-200'}
                ${isAdded ? 'opacity-50 pointer-events-none' : ''}
            `;

            return (
                <div id={`available-test-${localTempId}`} className={cardClasses}>
                    <div className="flex items-center flex-grow">
                        {/* Replaced input checkbox with a styled button/svg for consistency */}
                        <button
                            onClick={handleCheckboxClick}
                            className={`w-6 h-6 rounded-full border-2 ${test.completed ? "bg-green-500 border-green-500" : "border-gray-300"} mr-3`}
                            aria-label={test.completed ? "Mark as incomplete" : "Mark as complete"}
                        >
                            {test.completed && (
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    className="h-4 w-4 text-white m-auto"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                </svg>
                            )}
                        </button>
                        <div>
                            <h4 className="font-semibold text-gray-800">{test.title}</h4>
                            <p className="text-sm text-gray-500 mt-1">{test.mcqs} MCQs - {subject}</p>
                        </div>
                    </div>
                    <button
                        className={`text-white px-3 py-1 rounded-full text-sm transition duration-200
                        ${isAdded ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'}`}
                        onClick={() => onAdd(test, subject)}
                        disabled={isAdded}
                    >
                        {isAdded ? 'Added' : 'Add'}
                    </button>
                </div>
            );
        });

        // EditFocusPage Component - Now correctly uses isLoadingTodayFocus
        const EditFocusPage = React.memo(({ testData, todayFocusItems, addFocusItem, removeFocusItem, reorderFocusItems, onBackToDashboard, handleToggleTestCompletion, isLoadingTodayFocus }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedAvailableSubject, setSelectedAvailableSubject] = useState('');
            // Lazy initialization for localFocusItems to prevent stutter
            const [localFocusItems, setLocalFocusItems] = useState(() =>
                todayFocusItems.map((item, index) => ({ ...item, order: item.order !== undefined ? item.order : index }))
            );

            // This useEffect now *only* updates localFocusItems when todayFocusItems prop changes
            useEffect(() => {
                setLocalFocusItems(todayFocusItems.map((item, index) => ({ ...item, order: item.order !== undefined ? item.order : index })));
            }, [todayFocusItems]);

            const allTests = Object.keys(testData).flatMap(subject =>
                testData[subject].map(test => ({ ...test, subject, id: `${subject}-${test.title}` }))
            );

            const filteredAllTests = allTests.filter(test => {
                const matchesSubject = selectedAvailableSubject === '' || test.subject === selectedAvailableSubject;
                const matchesSearch = test.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    test.subject.toLowerCase().includes(searchQuery.toLowerCase());
                return matchesSubject && matchesSearch;
            });

            const subjects = Object.keys(testData);

            const handleMoveUp = async (index) => {
                if (index > 0) {
                    const newOrder = [...localFocusItems];
                    [newOrder[index - 1], newOrder[index]] = [newOrder[index], newOrder[index - 1]];
                    setLocalFocusItems(newOrder);
                    await reorderFocusItems(newOrder);
                }
            };

            const handleMoveDown = async (index) => {
                if (index < localFocusItems.length - 1) {
                    const newOrder = [...localFocusItems];
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
                    setLocalFocusItems(newOrder);
                    await reorderFocusItems(newOrder);
                }
            };

            return (
                <div id="page-edit-focus" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-2">
                        <button onClick={onBackToDashboard} className="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            Back to Dashboard
                        </button>
                        <h1 className="text-xl font-bold text-gray-900">Edit Focus</h1>
                    </header>
                    <p className="text-gray-500 mb-6">Manage your daily focus items.</p>

                    <h2 className="text-lg font-semibold text-gray-800 mb-4">Today's Focus Items</h2>
                    {isLoadingTodayFocus ? (
                        <LoadingSpinner />
                    ) : localFocusItems.length === 0 ? (
                        <p className="text-gray-500 text-center mb-6">No focus items added yet. Add from "Available Tests".</p>
                    ) : (
                        <div className="flex flex-col space-y-4 mb-8 max-h-[300px] overflow-y-auto no-scrollbar pr-2">
                            {localFocusItems.map((item, index) => (
                                <FocusItemCard
                                    key={item.id}
                                    item={item}
                                    onRemove={removeFocusItem}
                                    onMoveUp={() => handleMoveUp(index)}
                                    onMoveDown={() => handleMoveDown(index)}
                                    isFirst={index === 0}
                                    isLast={index === localFocusItems.length - 1}
                                    allowReorder={true}
                                    handleToggleTestCompletion={handleToggleTestCompletion}
                                />
                            ))}
                        </div>
                    )}

                    <hr className="my-6 border-t border-gray-200" />

                    <h3 className="font-bold text-gray-900 mb-4 my-6">Available Tests to Add</h3>
                    <div className="mb-4">
                        <label htmlFor="select-available-subject" className="block text-sm font-medium text-gray-700 mb-1">Filter by Subject:</label>
                        <select
                            id="select-available-subject"
                            className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={selectedAvailableSubject}
                            onChange={(e) => setSelectedAvailableSubject(e.target.value)}
                        >
                            <option value="">All Subjects</option>
                            {subjects.map(subject => (
                                <option key={subject} value={subject}>{subject}</option>
                            ))}
                        </select>
                    </div>

                    <div className="mb-6">
                        <input
                            type="text"
                            placeholder="Search available tests..."
                            className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>

                    <div id="available-tests-list" className="space-y-3 mb-8">
                        {filteredAllTests.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No tests available to add matching your filters.</p>
                        ) : (
                            filteredAllTests.map(test => (
                                <AvailableTestCard
                                    key={test.id}
                                    test={test}
                                    subject={test.subject}
                                    isAdded={todayFocusItems.some(item => item.id === test.id || (item.subject === test.subject && item.title === test.title))}
                                    onAdd={addFocusItem}
                                    onRemove={removeFocusItem}
                                    handleToggleTestCompletion={handleToggleTestCompletion}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        });

        const ManagedSubjectSection = React.memo(({ subjectName, tests, onDeleteSubject, onDeleteTest }) => {
            return (
                <div className="bg-gray-100 p-4 rounded-lg shadow-sm mb-4">
                    <div className="flex justify-between items-center mb-3">
                        <h3 className="font-bold text-lg text-gray-800">{subjectName}</h3>
                        <button
                            onClick={() => onDeleteSubject(subjectName)}
                            className="p-1.5 rounded-full text-gray-400 hover:text-red-500 transition-colors duration-200"
                            aria-label="Delete subject"
                        >
                            {/* Trash icon for delete subject */}
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                    <div className="space-y-2">
                        {tests.length === 0 ? (
                            <p className="text-gray-500 text-sm italic">No tests in this subject.</p>
                        ) : (
                            tests.map(test => (
                                <div key={test.title} className="flex justify-between items-center bg-white p-3 rounded-md border border-gray-200 text-sm">
                                    <span>{test.title} ({test.mcqs} MCQs, {test.date})</span>
                                    <button
                                        onClick={() => onDeleteTest(subjectName, test.title)}
                                        className="p-1.5 rounded-full text-gray-400 hover:text-red-500 transition-colors duration-200 ml-2"
                                        aria-label="Delete test"
                                    >
                                        {/* Trash icon for delete test */}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        });

        const ManageContentPage = React.memo(({ testData, addSubject, addTest, deleteSubject, deleteTest, onBackToProfile }) => {
            const [newSubjectName, setNewSubjectName] = useState('');
            const [selectedSubjectForTest, setSelectedSubjectForTest] = useState('');
            const [newTestTitle, setNewTestTitle] = useState('');
            const [newTestMcqs, setNewTestMcqs] = useState('');
            const [newTestDate, setNewTestDate] = useState('');
            const [newTestLink, setNewTestLink] = useState('');

            useEffect(() => {
                const subjects = Object.keys(testData);
                if (subjects.length > 0 && !selectedSubjectForTest) {
                    setSelectedSubjectForTest(subjects[0]);
                }
            }, [testData, selectedSubjectForTest]);

            const handleAddSubject = () => {
                addSubject(newSubjectName);
                setNewSubjectName('');
            };

            const handleAddTest = () => {
                if (!selectedSubjectForTest) {
                    console.error("No subject selected for adding test.");
                    return;
                }
                addTest(selectedSubjectForTest, newTestTitle, newTestMcqs, newTestDate, newTestLink);
                setNewTestTitle('');
                setNewTestMcqs('');
                setNewTestDate('');
                setNewTestLink('');
            };

            const subjects = Object.keys(testData);

            return (
                <div id="page-manage-tests" className="page px-6 py-8">
                    <header className="flex items-center justify-between mb-6">
                        <h1 className="text-3xl font-bold text-gray-900">Manage Content</h1>
                        <button onClick={onBackToProfile} className="text-blue-600 hover:text-blue-800 text-sm font-medium">Done</button>
                    </header>

                    <h2 className="text-xl font-bold text-gray-800 mb-4">Add New Subject</h2>
                    <div className="mb-8 p-4 bg-gray-100 rounded-lg">
                        <div className="mb-4">
                            <label htmlFor="new-subject-name" className="block text-sm font-medium text-gray-700 mb-1">Subject Name</label>
                            <input type="text" id="new-subject-name" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Biochemistry" value={newSubjectName} onChange={(e) => setNewSubjectName(e.target.value)} />
                        </div>
                        <button onClick={handleAddSubject} className="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                            Add Subject
                        </button>
                    </div>

                    <h2 className="text-xl font-bold text-gray-800 mb-4">Add New Test</h2>
                    <div className="mb-8 p-4 bg-gray-100 rounded-lg">
                        <div className="mb-4">
                            <label htmlFor="select-subject-for-test" className="block text-sm font-medium text-gray-700 mb-1">Select Subject</label>
                            <select id="select-subject-for-test" className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value={selectedSubjectForTest} onChange={(e) => setSelectedSubjectForTest(e.target.value)}>
                                <option value="">Select a Subject</option>
                                {subjects.map(subject => (
                                    <option key={subject} value={subject}>{subject}</option>
                                ))}
                            </select>
                        </div>
                        {selectedSubjectForTest && (
                            <>
                                <div className="mb-3">
                                    <label htmlFor="new-test-title-manage" className="block text-sm font-medium text-gray-700 mb-1">Add New Test:</label>
                                    <input
                                        type="text"
                                        id="new-test-title-manage"
                                        className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Test Title"
                                        value={newTestTitle}
                                        onChange={(e) => setNewTestTitle(e.target.value)}
                                    />
                                </div>
                                <div className="mb-3">
                                    <label htmlFor="new-test-mcqs-manage" className="block text-sm font-medium text-gray-700 mb-1">Number of MCQs:</label>
                                    <input
                                        type="number"
                                        id="new-test-mcqs-manage"
                                        className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., 50"
                                        value={newTestMcqs}
                                        onChange={(e) => setNewTestMcqs(e.target.value)}
                                    />
                                </div>
                                <div className="mb-3">
                                    <label htmlFor="new-test-date-manage" className="block text-sm font-medium text-gray-700 mb-1">Date:</label>
                                    <input
                                        type="date"
                                        id="new-test-date-manage"
                                        className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={newTestDate}
                                        onChange={(e) => setNewTestDate(e.target.value)}
                                    />
                                </div>
                                <div className="mb-4">
                                    <label htmlFor="new-test-link-manage" className="block text-sm font-medium text-gray-700 mb-1">Test Link (Optional):</label>
                                    <input
                                        type="url"
                                        id="new-test-link-manage"
                                        className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., https://example.com/test"
                                        value={newTestLink}
                                        onChange={(e) => setNewTestLink(e.target.value)}
                                    />
                                </div>
                                <button onClick={handleAddTest} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 mb-4">
                                    Add Test
                                </button>
                                {/* REMOVED THIS DUPLICATE SECTION */}
                                {/*
                                <hr className="my-4 border-t border-gray-200" />
                                <h3 className="font-medium text-gray-800 mb-2">Tests in {selectedSubjectForTest}:</h3>
                                <div className="space-y-2">
                                    {testData[selectedSubjectForTest] && testData[selectedSubjectForTest].length > 0 ? (
                                        testData[selectedSubjectForTest].map(test => (
                                            <div key={test.title} className="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                                                <span>{test.title} ({test.mcqs} MCQs, {test.date})</span>
                                                <button onClick={() => deleteTest(selectedSubjectForTest, test.title)} className="text-red-500 hover:text-red-700 text-sm font-medium">Delete</button>
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-gray-500 text-center">No tests for this subject.</p>
                                    )}
                                </div>
                                */}
                            </>
                        )}
                    </div>

                    <h2 className="text-xl font-bold text-gray-800 mb-4">Existing Content</h2>
                    <div id="manage-content-list" className="space-y-4">
                        {subjects.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No subjects available. Add a new subject above.</p>
                        ) : (
                            subjects.map(subject => (
                                <ManagedSubjectSection
                                    key={subject}
                                    subjectName={subject}
                                    tests={testData[subject]}
                                    onDeleteSubject={deleteSubject}
                                    onDeleteTest={deleteTest}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        });

        const ProfilePage = React.memo(({ onManageContent, onLogout, currentUserId, userName, userEmail, onResetLocalData }) => {
            const showUnimplementedFeatureNotification = () => {
                if (typeof window.showNotification === 'function') {
                    window.showNotification('This feature is not yet implemented.', 'info');
                } else {
                    console.warn('showNotification function is not available.');
                }
            };

            return (
                <div id="page-profile" className="page px-6 py-8">
                    <header className="mb-6">
                        <h1 className="text-3xl font-bold text-gray-900">My Profile</h1>
                        <p className="text-gray-500 mt-2">Manage your account and app settings.</p>
                    </header>

                    <div className="bg-gray-100 p-6 rounded-lg shadow-md mb-6">
                        <div className="flex items-center space-x-4">
                            <img src="https://placehold.co/80x80/E2E8F0/4A5568?text=NK" alt="User Avatar" className="w-16 h-16 rounded-full" />
                            <div>
                                <h2 className="text-xl font-bold text-gray-800">{userName || 'User'}</h2>
                                <p className="text-gray-600 text-sm">{userEmail || 'No Email'}</p>
                                <p className="text-xs text-gray-500 break-all">User ID: {currentUserId || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-4 mb-8">
                        <div
                            className="w-full bg-blue-50 text-blue-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-between hover:bg-blue-100 transition duration-200 cursor-pointer"
                            onClick={showUnimplementedFeatureNotification}
                        >
                            Edit Profile
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                        <div
                            className="w-full bg-blue-50 text-blue-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-between hover:bg-blue-100 transition duration-200 cursor-pointer"
                            onClick={showUnimplementedFeatureNotification}
                        >
                            Subscription
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                        <button onClick={onManageContent} className="w-full bg-blue-50 text-blue-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-between hover:bg-blue-100 transition duration-200">
                            Manage Subjects & Tests
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>

                    <div className="mt-auto pt-6 border-t border-gray-200">
                        <button onClick={onResetLocalData} className="w-full bg-yellow-100 text-yellow-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center hover:bg-yellow-200 transition duration-200 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9 0 0 0 6.74-2.74L21 16"></path><path d="M16 21v-5h5"></path></svg>
                            Reset Local App Data
                        </button>
                        <button onClick={onLogout} className="w-full bg-red-100 text-red-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center hover:bg-red-200 transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="17 16 22 12 17 8"></polyline><line x1="22" y1="12" x2="10" y2="12"></line></svg>
                            Logout
                        </button>
                    </div>
                </div>
            );
        });

        const BottomNavigation = React.memo(({ currentPage, onNavigate }) => {
            const navItems = [
                { page: 'dashboard', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> },
                { page: 'timetable', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> },
                { page: 'trophy', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg> },
                { page: 'profile', icon: <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> },
            ];

            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-40 transition-colors duration-300">
                    <div className="flex justify-around h-16 max-w-md mx-auto">
                        {navItems.map((item) => (
                            <button
                                key={item.page}
                                onClick={() => onNavigate(item.page)}
                                className={`flex flex-col items-center justify-center flex-1 text-center text-xs transition-colors duration-200 ${
                                currentPage === item.page ? 'text-blue-600' : 'text-gray-500 hover:text-gray-700'
                                }`}
                            >
                                {React.cloneElement(item.icon, {
                                    className: `mb-1 ${currentPage === item.page ? 'text-blue-600' : 'text-gray-500'}`
                                })}
                                <span className="font-medium capitalize">{item.page}</span>
                            </button>
                        ))}
                    </div>
                </nav>
            );
        });

        // Main App Component (Updated to handle isLoadingTodayFocus and improved render logic)
        const App = () => {
            const [currentPage, setCurrentPage] = useState('login');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [notification, setNotification] = useState({ message: '', type: '', visible: false });
            const [notificationPermission, setNotificationPermission] = useState('default');
            const [userId, setUserId] = useState(null);
            const [userName, setUserName] = useState(null);
            const [userEmail, setUserEmail] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isLoadingApp, setIsLoadingApp] = useState(true); // Renamed from isLoading for clarity
            const [isLoadingTodayFocus, setIsLoadingTodayFocus] = useState(true); // Specific loading for Today's Focus
            const [testData, setTestData] = useState({});
            const [timetableEntries, setTimetableEntries] = useState([]);
            const [currentSelectedSubject, setCurrentSelectedSubject] = useState('');
            const [currentTimetableSubject, setCurrentTimetableSubject] = useState('');

            // Refs to hold the latest values of currentSelectedSubject and currentTimetableSubject
            // This allows onSnapshot callbacks to access the most recent state without re-subscribing listeners
            const currentSelectedSubjectRef = useRef('');
            const currentTimetableSubjectRef = useRef('');

            // Update refs whenever state changes
            useEffect(() => {
                currentSelectedSubjectRef.current = currentSelectedSubject;
            }, [currentSelectedSubject]);

            useEffect(() => {
                currentTimetableSubjectRef.current = currentTimetableSubject;
            }, [currentTimetableSubject]);


            const [todayFocusItems, setTodayFocusItems] = useState([]);

            useEffect(() => {
                const storedLoggedIn = localStorage.getItem('isLoggedIn');
                const storedUserId = localStorage.getItem('userId');
                const storedUserName = localStorage.getItem('userName');
                const storedUserEmail = localStorage.getItem('userEmail');

                if (storedLoggedIn === 'true' && storedUserId) {
                    setUserId(storedUserId);
                    setUserName(storedUserName || 'Guest');
                    setUserEmail(storedUserEmail || '');
                    setIsLoggedIn(true);
                    setCurrentPage('dashboard');
                } else {
                    setIsLoggedIn(false);
                    setUserId(null);
                    setUserName(null);
                    setUserEmail(null);
                    setCurrentPage('login');
                    setIsLoadingApp(false); // No data to load if not logged in
                }
                setIsAuthReady(true);
            }, []);

            useEffect(() => {
                if ('Notification' in window) {
                    setNotificationPermission(Notification.permission);
                    if (Notification.permission === 'default') {
                        Notification.requestPermission().then(permission => {
                            setNotificationPermission(permission);
                        });
                    }
                }
            }, []);

            useEffect(() => {
                let unsubscribeFunctions = [];
                let timeoutId; // To ensure loading spinner goes away eventually

                if (isAuthReady && userId && window.db) {
                    setIsLoadingApp(true);
                    setIsLoadingTodayFocus(true);

                    // Set a timeout to remove the loading spinner even if some data streams fail to load quickly
                    timeoutId = setTimeout(() => {
                        if (isLoadingApp) { // Only dismiss if still loading
                            setIsLoadingApp(false);
                            showNotification("Some data streams might be delayed or failed to load. Please check your internet connection.", "error");
                        }
                    }, 15000); // 15-second timeout

                    const userSubjectsCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "subjects");
                    const userTimetableCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "timetable");
                    const userTodayFocusCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "todayFocus");

                    let loadedStreamsCount = 0;
                    const totalStreamsToLoad = 3;

                    const checkIfAllStreamsLoaded = () => {
                        loadedStreamsCount++;
                        if (loadedStreamsCount >= totalStreamsToLoad) { // Use >= for robustness
                            setIsLoadingApp(false);
                            if (timeoutId) clearTimeout(timeoutId); // Clear timeout if all loaded naturally
                        }
                    };

                    const handleError = (error, streamName) => {
                        console.error(`Error listening to ${streamName} data:`, error);
                        showNotification(`Failed to load ${streamName} data.`, 'error');
                        // Even if an error occurs, we still count this stream as "attempted to load"
                        // This ensures isLoadingApp is eventually set to false.
                        checkIfAllStreamsLoaded();
                    };

                    const unsubscribeSubjects = window.onSnapshot(userSubjectsCollectionRef, (snapshot) => {
                        const loadedTestData = {};
                        snapshot.forEach((doc) => {
                            loadedTestData[doc.id] = doc.data().tests || [];
                        });
                        setTestData(loadedTestData);

                        const availableSubjects = Object.keys(loadedTestData);
                        const latestSelectedSubject = currentSelectedSubjectRef.current;
                        const latestTimetableSubject = currentTimetableSubjectRef.current;
                        const persistedTimetableSubject = localStorage.getItem('currentTimetableSubject');

                        // Prioritize persisted subject if it's still valid
                        if (persistedTimetableSubject && availableSubjects.includes(persistedTimetableSubject)) {
                            setCurrentTimetableSubject(persistedTimetableSubject);
                            setCurrentSelectedSubject(persistedTimetableSubject); // Also set for trophy page if linked
                        } else if (availableSubjects.length > 0) {
                            // Fallback to first available if persisted is not found or invalid
                            if (!latestSelectedSubject || !availableSubjects.includes(latestSelectedSubject)) {
                                setCurrentSelectedSubject(availableSubjects[0]);
                            }
                            if (!latestTimetableSubject || !availableSubjects.includes(latestTimetableSubject)) {
                                setCurrentTimetableSubject(availableSubjects[0]);
                                localStorage.setItem('currentTimetableSubject', availableSubjects[0]); // Persist initial default
                            }
                        } else {
                            // No subjects at all
                            if (latestSelectedSubject !== '') {
                                setCurrentSelectedSubject('');
                                showNotification("No subjects found. Add new subjects to get started!", 'info');
                            }
                            if (latestTimetableSubject !== '') {
                                setCurrentTimetableSubject('');
                                localStorage.removeItem('currentTimetableSubject'); // Clear persisted if no subjects
                            }
                        }
                        checkIfAllStreamsLoaded();
                    }, (error) => handleError(error, "subjects"));
                    unsubscribeFunctions.push(unsubscribeSubjects);

                    const unsubscribeTimetable = window.onSnapshot(userTimetableCollectionRef, (snapshot) => {
                        const loadedTimetableEntries = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setTimetableEntries(loadedTimetableEntries);
                        checkIfAllStreamsLoaded();
                    }, (error) => handleError(error, "timetable"));
                    unsubscribeFunctions.push(unsubscribeTimetable);

                    const unsubscribeTodayFocus = window.onSnapshot(userTodayFocusCollectionRef, (snapshot) => {
                        const loadedFocusItems = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).sort((a, b) => (a.order || 0) - (b.order || 0));
                        setTodayFocusItems(loadedFocusItems);
                        setIsLoadingTodayFocus(false); // Specific loading finished for this stream
                        checkIfAllStreamsLoaded();
                    }, (error) => handleError(error, "Today's Focus"));
                    unsubscribeFunctions.push(unsubscribeTodayFocus);

                    return () => {
                        unsubscribeFunctions.forEach(unsub => unsub());
                        if (timeoutId) clearTimeout(timeoutId); // Clear timeout on unmount
                    };
                } else if (isAuthReady && !userId) {
                    setIsLoadingApp(false);
                    setIsLoadingTodayFocus(false);
                }
            }, [isAuthReady, userId, showNotification]); // Dependencies are now minimal and correct

            useEffect(() => {
                if (notification.visible) {
                    const timer = setTimeout(() => {
                        setNotification(prev => ({ ...prev, visible: false }));
                    }, 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification.visible]);

            const showNotification = useCallback((message, type = 'info') => {
                setNotification({ message, type, visible: true });
            }, []);

            const addSubject = useCallback(async (subjectName) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                if (!subjectName) { showNotification('Subject name is required.', 'error'); return; }
                if (testData.hasOwnProperty(subjectName)) { showNotification(`Subject "${subjectName}" already exists.`, 'error'); return; }

                try {
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    await window.setDoc(subjectDocRef, { tests: [] });
                    showNotification(`Subject "${subjectName}" added successfully.`, 'success');
                } catch (error) {
                    console.error("Error adding subject:", error);
                    showNotification(`Failed to add subject "${subjectName}".`, 'error');
                }
            }, [userId, testData, showNotification]);

            const addTest = useCallback(async (subjectName, title, mcqs, date, link = '') => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                if (!title || !mcqs || !date) { showNotification('All test fields (except link) are required.', 'error'); return; }
                if (!testData.hasOwnProperty(subjectName)) { showNotification('Subject does not exist. Please create the subject first.', 'error'); return; }
                if (testData[subjectName].some(test => test.title === title)) { showNotification(`A test with the title "${title}" already exists in ${subjectName}.`, 'error'); return; }

                try {
                    const newTest = { title, mcqs: parseInt(mcqs), date, link, completed: false };
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    const subjectDoc = await window.getDoc(subjectDocRef);
                    if (subjectDoc.exists()) {
                        const currentTests = subjectDoc.data().tests || [];
                        const updatedTests = [...currentTests, newTest];
                        await window.setDoc(subjectDocRef, { tests: updatedTests }, { merge: true });
                        showNotification(`Test "${title}" added to "${subjectName}".`, 'success');
                    } else {
                        showNotification('Subject document not found. This might be a sync issue. Please try refreshing.', 'error');
                    }
                } catch (error) {
                    console.error("Error adding test:", error);
                    showNotification(`Failed to add test "${title}".`, 'error');
                }
            }, [userId, testData, showNotification]);

            const deleteSubject = useCallback(async (subjectName) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                if (!testData.hasOwnProperty(subjectName)) { showNotification(`Subject "${subjectName}" not found.`, 'error'); return; }

                try {
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    await window.deleteDoc(subjectDocRef);

                    // Also remove associated focus items and timetable entries
                    setTodayFocusItems(prevItems => prevItems.filter(item => item.subject !== subjectName));
                    const todayFocusCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "todayFocus");
                    const qFocus = window.query(todayFocusCollectionRef, window.where("subject", "==", subjectName));
                    const snapshotFocus = await window.getDocs(qFocus);
                    snapshotFocus.forEach(async (doc) => {
                        await window.deleteDoc(window.doc(todayFocusCollectionRef, doc.id));
                    });

                    setTimetableEntries(prevEntries => prevEntries.filter(entry => entry.subject !== subjectName));
                    const timetableCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "timetable");
                    const qTimetable = window.query(timetableCollectionRef, window.where("subject", "==", subjectName));
                    const snapshotTimetable = await window.getDocs(qTimetable);
                    snapshotTimetable.forEach(async (doc) => {
                        await window.deleteDoc(window.doc(timetableCollectionRef, doc.id));
                    });

                    // This logic is now handled more robustly in the onSnapshot callback,
                    // but we can ensure it's cleared if the last subject is deleted.
                    const remainingSubjects = Object.keys(testData).filter(sub => sub !== subjectName);
                    if (remainingSubjects.length === 0) {
                        setCurrentSelectedSubject('');
                        setCurrentTimetableSubject('');
                    }

                    showNotification(`Subject "${subjectName}" deleted.`, 'success');
                } catch (error) {
                    console.error("Error deleting subject:", error);
                    showNotification(`Failed to delete subject "${subjectName}".`, 'error');
                }
            }, [userId, testData, showNotification]);

            const deleteTest = useCallback(async (subjectName, testTitle) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                if (!testData.hasOwnProperty(subjectName) || !testData[subjectName].some(test => test.title === testTitle)) {
                    showNotification(`Test "${testTitle}" not found in ${subjectName}.`, 'error'); return;
                }

                try {
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    const subjectDoc = await window.getDoc(subjectDocRef);
                    if (subjectDoc.exists()) {
                        const currentTests = subjectDoc.data().tests || [];
                        const updatedTests = currentTests.filter(test => test.title !== testTitle);
                        await window.setDoc(subjectDocRef, { tests: updatedTests }, { merge: true });

                        const todayFocusCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "todayFocus");
                        const qFocus = window.query(todayFocusCollectionRef,
                            window.where("subject", "==", subjectName),
                            window.where("title", "==", testTitle)
                        );
                        const snapshotFocus = await window.getDocs(qFocus);
                        snapshotFocus.forEach(async (doc) => {
                            await window.deleteDoc(window.doc(todayFocusCollectionRef, doc.id)); // Corrected: delete the doc
                        });

                        setTodayFocusItems(prevItems => prevItems.filter(item => !(item.subject === subjectName && item.title === testTitle)));
                        showNotification(`Test "${testTitle}" deleted from "${subjectName}".`, 'success');
                    } else {
                        showNotification('Subject document not found. This might be a sync issue. Please try refreshing.', 'error');
                    }
                } catch (error) {
                    console.error("Error deleting test:", error);
                    showNotification(`Failed to delete test "${testTitle}".`, 'error');
                }
            }, [userId, testData, showNotification]);

            const handleToggleTestCompletion = useCallback(async (subjectName, testTitle, completedStatus) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                try {
                    const subjectDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "subjects", subjectName);
                    const subjectDoc = await window.getDoc(subjectDocRef);

                    if (subjectDoc.exists()) {
                        const currentTests = subjectDoc.data().tests || [];
                        const updatedTests = currentTests.map(test =>
                            test.title === testTitle ? { ...test, completed: completedStatus } : test
                        );
                        await window.setDoc(subjectDocRef, { tests: updatedTests }, { merge: true });

                        const todayFocusCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "todayFocus");
                        const q = window.query(todayFocusCollectionRef,
                            window.where("subject", "==", subjectName),
                            window.where("title", "==", testTitle)
                        );
                        const snapshot = await window.getDocs(q);
                        // Only update if the item exists in todayFocus
                        snapshot.forEach(async (doc) => {
                            await window.setDoc(window.doc(todayFocusCollectionRef, doc.id), { completed: completedStatus }, { merge: true });
                        });

                        showNotification(`Test "${testTitle}" marked as ${completedStatus ? 'completed' : 'incomplete'}.`, 'success');
                    }
                } catch (error) {
                    console.error("Error toggling test completion:", error);
                    showNotification("Failed to update test completion status.", 'error');
                }
            }, [userId, showNotification]);

            const addFocusItem = useCallback(async (testToAdd, subjectName) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                const existingItem = todayFocusItems.find(item =>
                    (item.id === testToAdd.id && testToAdd.id !== `${subjectName}-${testToAdd.title}`) ||
                    (item.subject === subjectName && item.title === testToAdd.title)
                );

                if (existingItem) {
                    showNotification(`"${testToAdd.title}" is already in Today's Focus.`, 'info');
                    return;
                }

                try {
                    const iconPath = "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm13 14v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75";
                    const focusItemData = {
                        title: testToAdd.title,
                        mcqs: testToAdd.mcqs,
                        date: testToAdd.date,
                        link: testToAdd.link || '',
                        subject: subjectName,
                        iconPath: testToAdd.iconPath || iconPath,
                        completed: testToAdd.completed || false,
                        order: todayFocusItems.length
                    };

                    const todayFocusCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "todayFocus");
                    await window.addDoc(todayFocusCollectionRef, focusItemData);
                    showNotification(`Added "${testToAdd.title}" to Today's Focus.`, 'success');
                } catch (error) {
                    console.error("Error adding focus item:", error);
                    showNotification(`Failed to add "${testToAdd.title}" to Today's Focus.`, 'error');
                }
            }, [userId, todayFocusItems, showNotification]);

            const removeFocusItem = useCallback(async (itemId) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                try {
                    const todayFocusItemDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "todayFocus", itemId);
                    await window.deleteDoc(todayFocusItemDocRef);
                    showNotification('Focus item removed.', 'success');
                } catch (error) {
                    console.error("Error removing focus item:", error);
                    showNotification("Failed to remove focus item.", 'error');
                }
            }, [userId, showNotification]);

            const reorderFocusItems = useCallback(async (newOrder) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                try {
                    if (typeof window.writeBatch !== 'function') {
                        throw new Error("Firestore writeBatch function not available. Please ensure Firebase is initialized correctly.");
                    }
                    const batch = window.writeBatch(window.db);
                    const todayFocusCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "todayFocus");

                    newOrder.forEach((item, index) => {
                        const docRef = window.doc(todayFocusCollectionRef, item.id);
                        batch.update(docRef, { order: index });
                    });

                    await batch.commit();
                    showNotification('Focus items reordered.', 'success');
                } catch (error) {
                    console.error("Error reordering focus items:", error);
                    showNotification("Failed to reorder focus items.", 'error');
                }
            }, [userId, showNotification]);

            const addTimetableEntry = useCallback(async (subject, topic, date, time) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                if (!subject || !topic || !date || !time) { showNotification('All fields for the timetable event are required.', 'error'); return; }
                try {
                    const timetableCollectionRef = window.collection(window.db, "artifacts", window.__app_id, "users", userId, "timetable");
                    const newEntryRef = window.doc(timetableCollectionRef);
                    await window.setDoc(newEntryRef, { subject, topic, date, time, checked: false }); // Added checked: false
                    showNotification('Study event added successfully!', 'success');

                    if (notificationPermission === 'granted') {
                        const eventDateTime = new Date(`${date}T${time}`);
                        const now = new Date();
                        const timeUntilEvent = eventDateTime.getTime() - now.getTime();
                        const reminderTime = timeUntilEvent - (5 * 60 * 1000);

                        if (reminderTime > 0) {
                            setTimeout(() => {
                                new Notification('Upcoming Study Event', {
                                    body: `${topic} for ${subject} is starting soon at ${time}!`,
                                    icon: 'https://placehold.co/48x48/007bff/ffffff?text=ðŸ””'
                                });
                            }, reminderTime);
                        } else {
                            console.warn('Event is in the past or too soon for a reminder. No notification scheduled.');
                        }
                    } else {
                        console.warn('Notification permission not granted. Cannot schedule local notification.');
                    }
                } catch (error) {
                    console.error("Error adding timetable entry:", error);
                    showNotification("Failed to add study event.", 'error');
                }
            }, [userId, showNotification, notificationPermission]);

            const deleteTimetableEntry = useCallback(async (idToDelete) => {
                if (!userId) { showNotification('Authentication not ready. Please log in.', 'error'); return; }
                try {
                    const timetableEntryDocRef = window.doc(window.db, "artifacts", window.__app_id, "users", userId, "timetable", idToDelete);
                    await window.deleteDoc(timetableEntryDocRef);
                    showNotification('Timetable entry deleted.', 'success');
                } catch (error) {
                    console.error("Error deleting timetable entry:", error);
                    showNotification("Failed to delete timetable entry.", 'error');
                }
            }, [userId, showNotification]);

            const navigateTo = useCallback((pageName, options = {}) => {
                setCurrentPage(pageName);
                if (pageName === 'trophy' && options.fromTimetable && options.subject) {
                    setCurrentSelectedSubject(options.subject);
                }
                window.scrollTo(0, 0);
            }, []);

            const handleLogin = useCallback((enteredUsername, enteredPassword) => {
                const correctUsername = "nikhil";
                const correctPassword = "password123";
                const fixedUserId = "nikhil_user_id";

                if (enteredUsername === correctUsername && enteredPassword === correctPassword) {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userId', fixedUserId);
                    localStorage.setItem('userName', enteredUsername);
                    localStorage.setItem('userEmail', 'nikhil@example.com');
                    setUserId(fixedUserId);
                    setUserName(enteredUsername);
                    setUserEmail('nikhil@example.com');
                    setIsLoggedIn(true);
                    // Do NOT setCurrentPage('dashboard') here directly.
                    // The renderPage logic will handle the transition in the next render.
                    showNotification("Logged in successfully!", "success");
                } else {
                    showNotification("Invalid username or password.", "error");
                }
            }, [showNotification]);

            const handleLogout = useCallback(async () => {
                try {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('currentTimetableSubject'); // Clear persisted subject on logout

                    if (window.auth) {
                        await window.signOut(window.auth);
                    }

                    setUserId(null);
                    setUserName(null);
                    setUserEmail(null);
                    setIsLoggedIn(false);
                    setCurrentPage('login');
                    showNotification("Logged out successfully.", "info");
                } catch (error) {
                    console.error("Error during signOut or localStorage clear:", error);
                    showNotification("Failed to log out.", 'error');
                }
            }, [showNotification]);

            const handleResetLocalData = useCallback(() => {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userId');
                localStorage.removeItem('userName');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('currentTimetableSubject'); // Clear persisted subject on full reset
                window.location.reload();
            }, []);

            const renderPage = () => {
                // Overall App loading state:
                if (!isAuthReady || isLoadingApp) {
                    return <LoadingSpinner />;
                }

                // If not logged in, show login page. This is the ONLY path for non-logged-in users.
                if (!isLoggedIn) {
                    return <LoginPage onLogin={handleLogin} />;
                }

                // If logged in, but currentPage is 'login' (meaning a successful login just happened),
                // we set it to 'dashboard' and explicitly return null to force a re-render.
                // The actual DashboardPage will be rendered in the *next* cycle.
                if (currentPage === 'login' && isLoggedIn) {
                    setCurrentPage('dashboard');
                    return null; // Return null for this render to prevent immediate rendering of dashboard
                }

                // If we reach here, isLoggedIn is true, and currentPage is not 'login' (or will be 'dashboard' on next render)
                switch (currentPage) {
                    case 'dashboard':
                        return <DashboardPage
                            testData={testData} todayFocusItems={todayFocusItems} onEditFocus={() => navigateTo('edit-focus')}
                            removeFocusItem={removeFocusItem} onNavigate={navigateTo} userName={userName}
                            userEmail={userEmail} currentUserId={userId} handleToggleTestCompletion={handleToggleTestCompletion}
                            isLoadingTodayFocus={isLoadingTodayFocus} // Pass specific loading state
                        />;
                    case 'timetable':
                        return <TimetablePage
                            timetableEntries={timetableEntries} testData={testData} currentTimetableSubject={currentTimetableSubject}
                            setCurrentTimetableSubject={setCurrentTimetableSubject} setCurrentSelectedSubject={setCurrentSelectedSubject}
                            addTimetableEntry={addTimetableEntry} deleteTimetableEntry={deleteTimetableEntry}
                            navigateToTrophyPage={(subject) => navigateTo('trophy', { fromTimetable: true, subject })}
                            showNotification={showNotification} // Passed showNotification
                            userId={userId} // Passed userId
                        />;
                    case 'trophy':
                        return <TestsCompletedPage
                            testData={testData} currentSelectedSubject={currentSelectedSubject} setCurrentSelectedSubject={setCurrentSelectedSubject}
                            addTest={addTest} deleteTest={deleteTest} handleToggleTestCompletion={handleToggleTestCompletion}
                        />;
                    case 'edit-focus':
                        return <EditFocusPage
                            testData={testData} todayFocusItems={todayFocusItems} addFocusItem={addFocusItem}
                            removeFocusItem={removeFocusItem} reorderFocusItems={reorderFocusItems}
                            onBackToDashboard={() => navigateTo('dashboard')} handleToggleTestCompletion={handleToggleTestCompletion}
                            isLoadingTodayFocus={isLoadingTodayFocus} // Pass the specific loading state here
                        />;
                    case 'manage-tests':
                        return <ManageContentPage
                            testData={testData} addSubject={addSubject} addTest={addTest}
                            deleteSubject={deleteSubject} deleteTest={deleteTest} onBackToProfile={() => navigateTo('profile')}
                        />;
                    case 'profile':
                        return <ProfilePage
                            onManageContent={() => navigateTo('manage-tests')} onLogout={handleLogout}
                            currentUserId={userId} userName={userName} userEmail={userEmail}
                            onResetLocalData={handleResetLocalData}
                        />;
                    default:
                        // This case should ideally not be reached
                        console.warn("renderPage: Unknown currentPage. Defaulting to Dashboard.");
                        return <DashboardPage
                            testData={testData} todayFocusItems={todayFocusItems} onEditFocus={() => navigateTo('edit-focus')}
                            removeFocusItem={removeFocusItem} onNavigate={navigateTo} userName={userName}
                            userEmail={userEmail} currentUserId={userId} handleToggleTestCompletion={handleToggleTestCompletion}
                            isLoadingTodayFocus={isLoadingTodayFocus} // Pass specific loading state
                        />;
                }
            };

            return (
                <>
                    <main id="main-content" className="pb-24">
                        <ErrorBoundary>{renderPage()}</ErrorBoundary>
                    </main>
                    {isLoggedIn && <BottomNavigation currentPage={currentPage} onNavigate={navigateTo} />}
                    {notification.visible && (
                        <NotificationMessage
                            message={notification.message}
                            type={notification.type}
                            onClose={() => setNotification(prev => ({ ...prev, visible: false }))}
                        />
                    )}
                </>
            );
        };

        // Render the main App component into the root div
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
